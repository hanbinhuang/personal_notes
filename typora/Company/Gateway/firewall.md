[TOC]



# 1.防火墙

## 1.1. 概念

​		“防火墙”（Firewall）术语来自建筑设计领域，是指用来起分割作用的墙，当某一部分着火时可以减缓或保护其他部分免受火灾影响。在计算机网络中，**防火墙是在两个或多个网络之间用于设置安全策略的一个或多个系统的组合**。  
​		防火墙起到隔离异常访问的作用，仅允许可靠的流量通过，从而保护了家庭和企业内部网络信息的安全。  
​		Linux防火墙通常包含两部分，分别为：  
​				①**netfilter**：内核空间，执行报文过滤规则。  
​				②**iptables**：用户空间，管理防火墙规则的命令行工具集，通过该工具与内核打交道将防火墙规则写入内核中，常被统称Linux防火墙，是一个报文状态检测防火墙。这意味着防火墙内部存储每一个连接的信息，并且可以将每一个报文关联到它所属的连接。这个信息非常有用，它用于自动打开响应报文的传输路径，因此在创建防火墙规则时，通常没有必要创建相反方向的防火墙规则，防火墙将自动计算出这个规则。

​		下图是一个典型的防火墙部署结构：

![image-20230310102036766](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230310102036766.png)

## 1.2.防火墙规则

### 1.2.1 防火墙的表包含：

​		①**filter**: 	  **过滤表**，完成报文过滤。  
​		②**nat**:   	   **网络地址转换表**，完成源/目的地址和端口的转换。  
​		③**mangle**:  **修改表**，完成报文修改。  
​		④**raw**:		 **原始表**，完成配置连接跟踪。    
​        ⑤**security**：安全Linux防火墙规则。

### 1.2.2 一个防火墙规则包含：

​		①**报文匹配规则**：用于检测报文是否符合该规则标准。  
​				每个防火墙的表又包含了很多规则链，每个表中的规则链名可能相同，但任务是不同的，报文按照一定顺序进入规则链中进行检查是否符合规则。  

​		②**处理目标**：对匹配的规则进行处理的方式（前四个为系统内置处理目标）  
​				**ACCEPT (接收)、DROP(丢弃)、QUEUE(入队)、RETURN(返回)**、REJECT(拒绝)、DNAT（目的网络地址转换）、SNAT（源网络地址转换）、MASQUERADE（伪装）、LOG、REDIRECT

​		**作用**：Netfilter 系统是数据包通过各个规则的链式处理过滤器。第一个规则若没有匹配， 则继续下一个规则匹配，直到数据报文命中 ACCEPT、DROP 或 REJECT 之一。如果直到最后一个仍未匹配，默认规则最后生效，具体的规则首先起作用。  
​		OpenWrt 的防火墙规则 也是如此，在配置文件中，默认规则在最前面，但最后生效，同级别的规则按照配置文件顺序先后生效。

## 1.3. 防火墙命令

### 1.3.1. iptables命令

​		所有的 iptables 命令，如果没有指定防火墙表就使用默认的 filter 表。  
​		编写规则语法：  
​				`iptables [-t table] 大写选项子命令 [规则号] 链名 匹配标准 -j 目标 (规则)`

| 命令                                                         | 功能描述                                                     | 备注                                                         |
| ------------------------------------------------------------ | :----------------------------------------------------------- | ------------------------------------------------------------ |
| **iptables -h**                                              | 显示帮助                                                     |                                                              |
| **iptables -t nat -n -L**                                    | 查看网络地址转换规则                                         | -n 是为了避免长时间的DNS解析                                 |
| **iptables -F**                                              | 清空整个防火墙/所选的规则链中的规则，未指定链则清空默认表中所有链规则 | 如：清空 filter 表中 INPUT 链的规则iptables -t filter -F INPUT |
| **iptables -P {chain} {policy}**                             | 默认策略设置。<br />策略：用于处理相应规则链中没被规则匹配的报文 | 如：设置输入链为默认拒绝iptables -P INPUT DROP               |
| **iptables -N**                                              | 自定义规则链的创建                                           | 如：iptables  -N UDP_FILTER                                  |
| **iptables -A --append**                                     | 将防火墙规则增加到所选规则链的末尾                           |                                                              |
| **iptables -D --delete**                                     | 在指定的规则链中删除规则。<br />①指定规则号来删除<br />②通过规则匹配来删除。 | 规则编号是指规则在规则链中的顺序号，从 1 开始增加。<br />注意：规则在规则链中的规则编号不是固定的，如果删除前面的规则，则后面的规则自动往前移动 |
| **iptables -I, --insert chain [rulenum] rule-specification** | 插入到规则链中的指定位置，如果不指定插入位置，则插入到规则链的第一个位置处 |                                                              |
| **iptables  -L，--list [chain]**                             | 查看防火墙规则，如果没有指明规则链，则所有的规则链均显示出来。 |                                                              |
| **iptables -n**                                              | 数字格式显示ip和端口                                         |                                                              |
| **iptables --line-numbers**                                  | 显示行号                                                     |                                                              |
| **iptables -x**                                              | 显示精确值，不要做单位换算                                   |                                                              |
| **iptables -t {table}**                                      | 指定表                                                       |                                                              |
| **iptables -v/-vvv/-vvvv**                                   | 显示详细信息                                                 |                                                              |
| **iptables -X**                                              | 删除自定义空链，若链内有规则则无法删除                       |                                                              |
| **iptables -Z**                                              | 计算器清零                                                   |                                                              |
| **iptables -E**                                              | 重命名自定义链                                               |                                                              |
| **iptables -R [n]**                                          | 替换规则链中的指定位置的规则                                 |                                                              |
| **iptables -s/ --src /--source**                             |                                                              |                                                              |
| **iptables -d**                                              |                                                              |                                                              |
| **iptables -i**                                              | 指定数据报文流入接口                                         | input prerouting forward                                     |
| **iptables -o**                                              | 指定数据报文流出接口                                         | output postrouting forward                                   |
| **iptables -p**                                              | 明确说明只放行哪种协议的报文匹配规则                         |                                                              |

举例：`iptables -t nat -nxvL`

```shell
Chain PREROUTING (policy ACCEPT 392856 packets, 67875994 bytes)
    pkts      bytes target     prot opt in     out     source               destination
       0        0 REDIRECT   all  --  *      *       0.0.0.0/0            10.44.77.253
       0        0 REDIRECT   all  --  *      *       0.0.0.0/0            10.44.77.254
  392858 67876320 PREROUTING_ruijie_chain  all  --  *      *       0.0.0.0/0            0.0.0.0/0
     240    19593 zone_lan_prerouting  all  --  *      *       0.0.0.0/0            0.0.0.0/0            match-set zone_lan_iface src,src
  392581 67851271 zone_wan_prerouting  all  --  *      *       0.0.0.0/0            0.0.0.0/0            match-set zone_wan_iface src,src

Chain INPUT (policy ACCEPT 265 packets, 74769 bytes)
    pkts      bytes target     prot opt in     out     source               destination
```

①.pkts 			     被本机报文所匹配的个数   
②.bytes 			   报文所有大小记起来之和   
③.target 		      处理机制   
④.prot 			     放行哪种协议   
⑤.opt 			      额外的选项，--表示没有   
⑥.in		     
⑦.out  
⑧.source 		    源地址   
⑨.destination 	目标地址

### 1.3.2 iptables-save命令

​		导出 iptables 规则到标准输出（即屏幕）中，我们使用 shell 的重定向命令可以将规则写入文件中。内容格式和 iptables 类似但稍有不同，这个格式便于程序解析。

### 1.3.3 iptables-restore命令

​		用于加载导出的防火墙规则，使用标准输入的内容来导入，一般都是通过 shell 提供的重定向从文件中读取规则之后来向内核导入规则。

## 1.4. 典型例子

### 1.4.1. 例1

​		从局域网发起流量均可通过，从互联网发起主动流量均不可通过，互联网被动报文均可通过（局域网主机请求的响应报文）。所有局域网请求转发后均进行网络地址转换，将源地址改为路由器地址。

```
WAN=eth0 
LAN=eth1 
#所有转发流量均默认禁止。 
iptables -t filter -P FORWARD DROP 
#局域网发起的连接进行转发 
iptables -t filter -A FORWARD -i $LAN -j ACCEPT 
#对所有符合连接跟踪状态的报文进行转发。 
iptables -t filter -A FORWARD -m state --state RELATED, ESTABLISHED -j ACCEPT 
#所有去往互联网的流量均进行地址伪装，即源地址改为路由器地址。 
iptables -t nat -A -o $WAN -j MASQUERADE 
```

### 1.4.2. 例2

例2：停止防火墙

```
#恢复内置链默认策略 
iptables -t filter -P FORWARD ACCEPT 
iptables -t filter -P INPUT ACCEPT 
#以下命令清空表中所有的规则 
iptables -F 
iptables -t nat -F 
iptables -t mangle –F 
iptables -t raw -F
```



# 2. iptables中的表

​		iptables用来设置、维护和检查 Linux 内核的防火墙 IP 报文过滤规则和网络地址转换规则的。  
​		根据功能划分为五个不同的表，如下：

## 2.1. filter (过滤表)

​		**①简介**：默认表，主要用于报文过滤,根据报文内容对报文进行丢弃或接受。  
​						(主要和主机自身有关,过滤本机流入流出的数据包)  
​		**②规则链：**  
​				<1>INPUT 输入链：	处理目标地址为本机 IP 地址的报文。  
​				<2>OUTPUT 输出链：	处理本机IP 地址产生的报文。  
​				<3>FORWARD 转发链：处理经过本机路由的报文。  
​		**③说明：**  
​				每一个IP报文只经过这3个内置链中的一个，便于进行数据报文匹配和处理。 (这里是真正实现防火墙处理的地方)

## 2.2. nat (网络地址转换表)

​		**①简介**：完成源/目的地址和端口的转换，当一个报文在创建一个新的连接时进入该表  
​		**②规则链：**  
​				<1>PREROUTING： 用于修改到来的报文，只用来做网络地址转换  
​				<2>OUTPUT： 	 用于修改本机产生的并且在路由处理之前的报文  
​				<3>POSTROUTING：用于修改准备出去的报文的地方  
​				<4>INPUT:		 用于  
​		**③说明：**  
​				<1>通过目的地址转换，可将服务器放在防火墙后面，并使用私有 IP 地址。  
​				<2>一些协议通过 nat 转换有困难（例如 FTP 或 SIP），连接跟踪将打开这些协议的数据/媒体流路径。  
​				<3>nat表不能用于报文过滤和报文修改，因为每一个连接流仅有一次机会进入该表中的规则链  
​				<4>网络地址转换在路由功能前后都可能发生，  
​					1.源地址转换是在数据包通过路由之后在 POSTROUTING 规则链进行地址转换  
​					2.目的地址转换是在路由之前，在 PREROUTING 规 则链进行地址转换

## 2.3. mangle (修改表)

​		**①简介**：主要用来进行报文修改  
​		**②规则链：**  
​				<1>REROUTING：	 针对到来的报文，在路由之前修改的地方  
​				<2>INPUT：		 针对目的地址为网关本身的报文  
​				<3>FORWARD：	 针对通过网关路由转发的报文  
​				<4>POSTROUTING：将要发送出去的报文的地方  
​				<5>OUTPUT：		 本机产生报文在路由之前修改的地方  
​		**③说明：**  
​				<1>通常使用该表进行报文修改，以便进行QoS和策略路由。  
​				<2>通常每一个报文都进入该表，但不使用它来做报文过滤

## 2.4. raw (原始表)

​		**①简介**：主要用于配置连接跟踪相关内容，在ip_conntrack之前调用  
​		**②规则链：**  
​				<1>PREPROUTING：到达本机的报文  
​				<2>OUTPUT：本机进程产生的报文  
​		**③说明：**  
​				能够在连接跟踪生效前处理报文的地方，可标记符合某种条件的报文不被连接跟踪处理。

## 2.5. security ()

​		**①简介**：用于安全Linux的防火墙规则  

# 3. iptables中的处理目标

​		防火墙规则检测报文的特征是否符合规则，  
​				①若报文匹配，就进入规则的处理目标（TARGET）中。  
​				②若报文不匹配，则进入该规则链的下一条规则进行检测。  
​		就这样**逐条规则**进行比较，直到整个规则链比较完成。  
​		规则的规则处理目标可是用户自定义，也可是系统内置的处理方式（4种）。  
​				**①ACCEPT (接收)**： 报文通过.  
​				**②DROP(丢弃)**：	  报文丢弃,不做任何处理.  
​				**③QUEUE(入队)**：	报文传递到用户空间的队列中  
​				**④RETURN(返回)**:     返回主链继续匹配。停止这条规则链的匹配，返回到调用这个规则链的上一条规则链的规则处执行。若到达了一个内建的规则链的末端，或者遇到内置链的规则目标是 RETURN，报文的命运将由规则链指定的默认目标处理方式决定。  
​		其他扩展的目标处理方式，如：  
​				**①REJECT(拒绝)**：	报文丢弃,但会返回错误信息。  
​						<1>与DROP一样。不同之处在于同时还向发送者返回一个ICMP错误消息。这样发送者将知道报文被丢弃，如果发送端检测到返回的错误信息， 将不再尝试发送报文，这样可以在特定条件下减少发送端重发报文。（若使用DROP则可能导致继续使用重传机制使程序挂起等待超时才回继续往下执行）  
​						<2>与DROP相比，调试网络问题更方便，发送方可得到错误信息，但同时暴露给攻击者的信息更多，相对于DROP更不安全。  
​						<3>若大量的访问或攻击则会产生大量的ICMP消息，导致占用所有带宽而合法连接不可用。  
​						<4>DROP与REJECT利弊总结:

| 处理方式 |                        利                        |                              弊                              |
| :------: | :----------------------------------------------: | :----------------------------------------------------------: |
|   DROP   |           1. 信息暴露较少2. 攻击面减少           | 1. 客户端软件可能无法很好处理 （程序挂起直到连接超时）2. 可能使得网路调试复杂化（报文丢弃搞不清问题出现原因） |
|  REJECT  | 1. 客户端软件可立即从拒绝中恢复2. 网络调试更容易 |                   1.暴露防火墙的IP地址信息                   |

 					<5>举例：  
							禁止访问主机上80端口的服务，访问者将收到端口不可达的ICMP消息  
							`							iptables -A IPNUT -p tcp --dport 80 -j REJECT`  
				**②DNAT（目的网络地址转换）**  
					<1>使用场景：局域网内多个服务器需对互联网机器提供服务时，则需该目标处理方式。  
					<2>作用：  实现目的网络地址转换的，即重写报文的目的IP地址。  
							若一个报文被匹配了，那么和它属于同一个流的所有报文都会被自动转换，然后就可以被路由到正确的主机或网络。  
					<3>作用目标规则链：  
							仅可用在nat表中的PREROUTING和OUTPUT链以及被这些链调用的自定义链中  
					<4>举例：  
							将访问路由器的80端口的流量重定向到192.168.6.100上：（这样Web服务器就可以搭建在局域网的主机（192.168.6.100）上对外提供服务，处理流程如下）    
						1> 报文进入防火墙之后，将目标地址修改为 192.168.6.100，然后离开防火墙到达HTTP服务器.  
						2> TTP服务器处理完成后，将源地址改为目标地址，使用自身IP作为源地址发送报文.  
						3> 防火墙收到响应报文后将报文的源地址转换为防火墙的出接口地址，然后返回给请求方。整个通信流程完成.  
`	iptables -t nat -A PREROUTING -p tcp --dport 80 -j DNAT --to-destination 192.168.6.100`  
				**③SNAT（源网络地址转换）**  
					**<1>使用场景：**常用于仅有少量固定IP地址上网的情形，局域网的私有地址在访问因特网时，源地址被路由器外网地址替换  					**<2>作用：** 另一种网络地址转换方式。 指定报文的源地址将被修改，它至少需要一个参数-源地址，报文的源地址将被指定地址替换。此连接的后续报文并不进入该规则中， 连接中的报文源IP均被自动替换.  
					**<3>作用目标规则链：**  
							仅可用在nat表中的POSTROUTING和INPUT链以及被这些链调用的自定义链中.  
					**<4>举例：**  
					设置参考命令如下：  
`		iptables -t nat -A POSTROUTING –s 192.168.6.0/24 –o eth0 -j SNAT --to-source 10.0.2.15`  
				**④MASQUERADE（伪装）**  
					**<1>使用场景：**大多数情况下，路由器并没有一个固定的IP 地址。我们的路由器是通过 PPPoE 拨号上网或者是通过DHCP自动分配的 IP 地址。这 个处理目标和SNAT处理目标作用是一样的，区别就是它不需要指定源地址。  
					**<2>作用：**地址伪装。专门设计用于那些动态获取IP地址的连接，如：拨号上网、DHCP连接等。  
					若有固定的IP地址，还是用SNAT处理目标，这样可以节省计算资源  
					**<3>作用目标规则链：** 只能用于nat表的POSTROUTING链  
					**<4>举例：**  
							局域网来自192.168.6.0网络的报文通过MASQUERADE进行源地址转换:  
`		iptables -t nat -A POSTROUTING –s 192.168.6.0/24 –o eth0 -j MASQUERADE`  
				**⑤LOG**  
					**<1>使用场景：**查看匹配包的信息  
					**<2>作用：**为匹配的报文开启内核记录，当在规则中设置了这一选项后，Linux内核会通过printk函数打印一些关于匹配包的信息，然后通过syslog机制记录在日志文件中。该处理目标并非最终目标，处理完成后，报文还会接着进入下一条规则继续匹配。  
					**<3>选项设置：**  
							1> --log-level：日志级别    
							2> --log-prefix：prefix 在记录 log 信息前加上的特定前缀：最多 14 个字母长，用来和 日志中其他信息区别  
							3> --log-tcp-sequence：记录 TCP 序列号  
							4> --log-tcp-options：记录 TCP 报文头部的选项  
							5> --log-ip-options：记录 IP 报文头部的选项  
					**<4>举例：**  
				**⑥REDIRECT**  
					**<1>使用场景：**  
					**<2>作用：** 端口重定向。修改报文的目标IP地址来发送报文到机器自身（本地生成的报文被设置为地址127.0.0.1）。经常用于HTTP代理，例如将80端口的HTTP请求重定向到SQUID的3128端口  
					**<3>作用目标规则链：**  
							nat表的PREROUTING和OUTPUT链，以及它们调用的用户自定义链。  
							指定使用的目的端口或端口范围。不指定的话，目标端口不会被修改。只能用于指定了TCP或UDP的规则。  
							iptables中的所有表都是小写字母表示，内置规则链均大写字母表示，所有处理目标均以大写字母表示  
				 **<4>选项设置：**  
				**<5>举例：**  
				**⑦MARK(打标签)：**

# 4. **报文处理流程：**

​		iptables 有 5 个表，每一个表中又有几个不同的链，不同的表中有相同名称的规则链， 但这些规则链处理的任务是不同的。报文按照预定的流程来顺序进入到各个规则链中，报文处理流程如下图所示。同一名称规则链根据表的先后顺序进入，进入顺序依次是 raw、mangle、filter 和 nat。   
​		**①报文在链表处理流程：**

![img](file:///C:\Users\acer\AppData\Local\Temp\ksohtml10952\wps3.jpg) 

​																	报文在 IPTABLES 的链表处理流程

报文从网络来，首先进入到 PREROUTING 链中进行处理，再对目标 IP 地址进行判断。  
				<1>若目标 IP 地址和本机相同：把报文转到 INPUT 链，再转到应用程序  
				<2>若目标 IP 地址和本机不同：该报文为转发报文，进入FORWARD 链，再经过 POSTROUTING 链发出报文。

​		**②网络报文处理流程**

![img](file:///C:\Users\acer\AppData\Local\Temp\ksohtml10952\wps4.jpg) 

​														**网络报文处理流程**

​		<1>首先网卡从网络上收到 IP 报文。  
​		<2>报文进入 raw 表的 PREROUTING 链。这里能够在连接跟踪生效前对报文进行处理，你可以标记某种类型的报文不被连接跟踪处理。一般很少使用  
​		<3>报文进入到连接跟踪处理。这里是收到报文进行连接跟踪处理的位置。  
​		<4>报文进入到 mangle 表的 PREROUTING链。这里是报文进入网关之后、路由之前修改报文的地方。  
​		<5>报文进入到 nat 表的 PREROUTING 链。在这里我们做目的地址转换（DNAT）。这里不能用于报文过滤，因为每一个连接数据流仅第一个报文进入到这里。  
​		<6>进行路由决策，因为前面的 mangle和 nat 表可能修改了报文的 IP 地址信息。如果目标地址为网关，则直接进入到INPUT链中，如果和本机地址不同，则是进入路由转发，跳到第 9 步的转发表中。  
​		<7>报文进入到 mangle 表的 INPUT 链。这里是报文进入网关时修改报文的地方，在这里做报文过滤是不被推荐的，因为它可能有副作用。通常也很少修改报文。  
​		<8>报文进入到 filter 表的 INPUT 链。这里是对收到报文做过滤的地方，然后将报文转到应用程序。  
​		<9>报文进入到 filter 表的 INPUT 链。这里是对收到报文做过滤的地方，然后将报文转到应用程序。  
​		<10>报文进入到 filter 表中的 FORWARD 链，对转发报文进行过滤。这里是唯一适合对转发报文过滤的地方。所有的转发报文均经过这个规则链。  
​		<11>报文进入到 mangle 表的 POSTROUTING 链。这条链可能被两种报文遍历，一种是转发的报文，另外就是本机产生的报文。这个链通常很少使用。  
​		<12>报文进入到 nat 表的 POSTROUTING 链。在这里我们做源地址转换（SNAT）。这里不能用于报文过滤，因为每一个数据流仅有第一个报文进入到这里。  
​		<13>最后经过网卡发送报文。 

**③本机产生报文处理流程**

​		若应用程序发送报文则在 netfilter中是另外的处理流程，报文则首先通过 OUTPUT 链，然后经过 POSTROUTING 链再发送报文。网络报文 在各个表中的规则链中流动，按照 raw、 mangle、filter 和 nat 表的顺序依次进行匹配。

![img](file:///C:\Users\acer\AppData\Local\Temp\ksohtml10952\wps5.jpg) 

​																				**本机产生报文处理流程**

​		<1>首先本地进程产生报文，并进行路由选择，选择源 IP 地址及出接口设备。如果没有找到路由将直接返回失败。  
​		<2>进入 raw 表 OUTPUT 链。这里是能够在连接跟踪生效前处理报文的地方，你可以标记某种类型的报文不被连接跟踪处理。一般很少使用。  
​		<3>连接跟踪。这里是本地发出报文进行连接跟踪处理的位置。  
​		<4>进入到 mangle 表的 OUTPUT 链。这里是我们修改报文的地方。不推荐在这里做报文过滤，因为它可能有副作用。  
​		<5>进入到 nat 表 OUTPUT 链。这里对于本机发送的报文做目的地址转换（DNAT）。不能用于过滤，因为每一个数据流仅第一个报文进入到这里。  
​		<6>进入路由决策。因为前面的 mangle 和 nat 表可能修改了报文的 IP 地址信息。  
​		<7>进入到 filter 表的 OUTPUT 链。对本机发出报文做过滤的地方。  
​		<8>进入到 mangle 表的 POSTROUTING 链。这条链可能被两种报文遍历，一种是转发的报文，另外就是本机产生的报文  
​		<9>进入到 nat 表的 POSTROUTING 链。在这里我们做源地址转换（SNAT）。这里 不能用于报文过滤，因为每一个数据流仅有第一个报文进入到这里。   
​		<10>在网卡接口上发出报文，报文离开主机。

# 5. **报文规则匹配**

​		防火墙规则用于匹配报文，有多种匹配报文特征的方法，常见的有根据数据链路层、 IP 层及传输层特征进行匹配，甚至可以根据应用层特征进行匹配，例如用户、域名以及内容匹配等

## 5.1数据链路层：

​		MAC 地址过滤用于匹配报文以太网卡的物理地址。必须是 XX:XX:XX:XX:XX:XX 这样的格式。它只对来自以太网设备并进入 PREROUTING、FORWORD 和 INPUT 链的报文有效。  
​		**<1>注意**：MAC 地址过滤只对源 MAC 地址有效。  
​		**<2>格式**：`-m mac --mac-source [!] address。`   
​		**<3>规则举例**：将丢弃来自指定 MAC 的报文。  
​			`#>iptables -I INPUT -m mac --mac-source 28:D2:44:15:D5:A4 -j DROP`

## 5.2 IP层：

​		IP 层匹配常用的有协议、源 IP 地址和目标 IP 地址，经常和传输层的端口一起使用。  
​		**<1>格式:**  
​				1>`-p` 用于匹配 IP 层报头所指定的传输层协议。  
​						常见的协议为 TCP、UDP、IGMP、ICMP 者ALL等等。也可以是一个数字，数字代表的协议在文件/etc/protocols 描述。数字零表示所有协议。  
​				2>`-s `和`-d `用于匹配 IP 报文的源和目标 IP 地址。  
​						IP 地址可以是网络地址、主机名或具体 的 IP 地址。如果是主机名，在插入到内核之前将被解析为 IP 地址。网络掩码长度是指 IP 地址左边“1”的个数。例如 24 表示 255.255.255.0。

​		**<2>规则举例：**   
​			1>禁止 UDP 5060 报文通过  
​				`	#>iptables -A FORWARD -p UDP --m udp dport 5060 -j DROP`  
​			2>禁止 192.168.1.0 网段访问本机  
​				`#>iptables -A INPUT -s 192.168.1.0/24 -j DROP`

## 5.3 应用层：

**①owner 模块:**  
		用于匹配报文发起者，用于本机进程产生的报文，一般为用户或用户组 ID。   
		这些规则仅可以在 OUTPUT 和 POSTROUTING 链中使用。  
		转发的报文不会匹配到任何的用户信息，内核线程产生的报文也没有所有者，例如 ICMP 信息。这在一些严格限制仅限定用户进程可以通过的场合使用，每一个进程一个用户，这样可以非常方便地对进程加以区分.  
		**<1>规则举例：**  
				1>允许 1002 用户进程的报文通过：  
					`					#>iptables -I OUTPUT -m owner --uid-owner 1002 -j ACCEPT`  
**②接口匹配模块:**  
		提供了根据报文的出入接口来匹配的方法，如果不限定接口，规则将匹配所有的网卡接口网络  
		**（1）格式:**  
				**-i [name]**：这是报文经由该接口接收的流入接口名称，报文通过该网卡接口接收   
					（在规则链 INPUT、FORWORD 和 PREROUTING 中进入的报文）。  
				**-o [name]**：这是报文经由该接口发出的流出接口名称，报文通过网卡该口发送  
					（在规则链 FORWARD、OUTPUT 和 POSTROUTING 中送出的报文）。  
				在接口名称前使用**“!”**修饰后，指的是不为该接口的报文，如果接口名后面加上**“+”**，则所有以此接口名开头的接口都会被匹配。如果不指定这个选项，那么将匹配任意网卡接口的报文。

**③conntrack 连接跟踪:**  
		有状态防火墙的核心机制，用于存取这个报文的连接跟踪状态来计算匹配返回的报文。  
		state 是连接跟踪的子集，用于存取连接跟踪的报文状态。可选的状态列表如下:  
				**●NEW**：这个报文开始新的连接，是连接建立的第一个报文。例如 TCP 连接的第一个请求报文。   
				**● ESTABLISHED**：连接建立，这个报文关联的连接已经在双方向看到报文。   
				**● RELATED**：这个报文开始新的连接，但是关联到一个已存在的连接上，例如一个FTP数据传输或者一个 ICMP 错误。   
				**● UNTRACKED**：这个报文没有连接跟踪，如果你在raw表中使用-j CT -notrack进行了设置。   
				**● INVALID**：这这个报文没有关联到已知的连接。例如收到不属于已有连接的 ICMP错误信息  
		可以和任何网络协议一起来使用 iptables 连接跟踪的状态功能，状态功能支持 TCP、 UDP 和 ICMP 协议。下面的例子使用连接跟踪来只转发与已建立连接相关的分组报文，这种情况通常是禁止转发广域网的直接发起请求报文，这样就可以只用加入一条规则来允许局域网指定协议可以通过。  
				`#>iptables -A FORWARD -i eth0 -m state --state ESTABLISHED,RELATED -j ACCEPT `  
			iptables 还支持很多扩展模块，例如 connlimit，用于限制并行连接数等（请参考 iptables帮助手册）。

# 6. UCI防火墙

## 6.1. 引入

​		OpenWrt 使用 **Netfilter** 来实现**报文过滤**、**网络地址转换**和**报文修改**。直接采用iptables命令不便管理，故采用UCI配置管理防火墙规则，便于用户使用命令和Web接口管理，可分离路由器控制层和转发层。  
​		UCI防火墙封装了Netfilter配置接口，抽象防火墙系统特征来提供简单配置模型。

## 6.2. 安全域（zones）

​		防火墙的核心就是**规则**，所有规则在一起称做**规则集**。手动维护规则集非常困难，因此定义了安全域（zone）,减少管理负担。

​		**安全域**是一个相同规则的区域，可根据接口划分，包含一/多个接口，可同时定义多个接口默认规则，可在接口之间的转发规则，可配置**网络地址转换、端口转发规则、重定向等**。  
​		安全域必须映射到**一/多个接口**，并最终映射到多个物理接口设备，因此不能用于指定子网和按照iptables规则来操作物理设备接口。    当接口的子网包含另外一个网关时，可以用来达到目的地不属于自己的子网网络。  
​		通常转发是在**局域网和广域网**之间的接口完成，因此使用路由器作为局域网和因特网之间的边缘网关，最典型的只能路由器设置两个安全域**，wan-连接互联网，lan-连接因特网**。  
​		Netfilter 系统是数据包通过各个规则的链式处理过滤器。第一个规则如果没有匹配，则继续下一个规则匹配，直到数据报文命中 ACCEPT、DROP 或 REJECT 之一。如果直到最后一个仍未匹配，默认规则最后生效，具体的规则首先起作用。OpenWrt 的防火墙规则也是如此，在配置文件中，默认规则在最前面，但最后生效，同级别的规则按照配置文件顺序先后生效。

​		

## 6.2 防火墙配置

​		**配置文件路径**：`/etc/config/firewall`

### 6.2.1 Defaults-缺省（只有一个配置节点）

​		defaults缺省部分，至少两个安全域（局域网、广域网）和一个转发——允许局域网到广域网。

| 名称         | 类型   | 含义描述                                     |
| ------------ | ------ | -------------------------------------------- |
| input        | 字符串 | 设置过滤表的 INPUT 链的策略，默认为 REJECT   |
| output       | 字符串 | 设置过滤表的 OUTPUT 链的策略，默认为 REJECT  |
| forward      | 字符串 | 设置过滤表的 FORWARD 链的策略，默认为 REJECT |
| syn_flood    | 布尔值 | 启动 SYN 洪水攻击保护，默认不启用            |
| disable_ipv6 | 布尔值 | 关闭 IPv6 防火墙，默认打开                   |

如：

```shell
config defaults
        option syn_flood '1'
        option input 'ACCEPT'
        option output 'ACCEPT'
        option forward 'REJECT'
```



### 6.2.2  Zones-安全域（*两个不同的zone之间是隔离的*）

​		一个安全域根据接口来划分，可以包含一个或多个接口，在源和目的地之间进行转发、生成规则和重定向。  
​		输出的流量伪装是每一个安全域的基础控制。注意**伪装**是对即将报文离开的接口进行定义，是将报文的源 IP 地址转换为路由器的出口 IP 地址。  
​		**①INPUT规则**：用于匹配流量从这个安全域的接口到达路由器本身，即目的地址为路由器IP 地址的流量。  
​		**②OUTPUT规则：**用于处理从路由器自己产生的报文并通过安全域的接口，即作用于源地址为路由器地址的报文。  
​		**③FORWARD规则：**用于处理从一个安全域到另外一个安全域的报文，即经过路由器来转发的报文。

| 名称    | 类型   | 含义描述                                                     |
| ------- | ------ | ------------------------------------------------------------ |
| name    | 字符串 | 定义安全域的名称                                             |
| network | 链表   | 安全域的接口列表                                             |
| input   | 字符串 | 进入安全域报文的默认策略（ACCEPT、REJECT 或DROP），默认为DROP |
| forward | 字符串 | 转发流量的默认安全策略（ACCEPT、REJECT 或DROP），默认为DROP  |
| output  | 字符串 | 该安全域发出报文的默认策略（ACCEPT、REJECT 或DROP），默认为DROP |
| masq    | 布尔值 | 该安全域流量是否进行地址伪装，即是否进行地址转换，典型情况下 wan 域均启用该设置 |
| mtu_fix | 布尔值 | 对于所有的外出流量固定其最大分片大小值                       |

如：

```shell
config zone 'wannet'
        option name 'wan'
        option network 'wan'
        option input 'REJECT'
        option output 'ACCEPT'
        option forward 'REJECT'
        option masq '1'
        option mtu_fix '1'

config zone 'lannet'
        option name 'lan'
        option input 'ACCEPT'
        option output 'ACCEPT'
        option forward 'ACCEPT'
        option network 'lan'
```



### 6.2.3 forwarding-转发（用于不同zone之间的转发）

​		转发部分控制安全域之间的数据流量，可以使 MSS（最大分片大小）为特定的方向。  
​		**一个转发规则仅代表一个方向**。允许两个区域之间的双向流量，这需要两个转发规则，src 和 dest 部分颠倒过来即可，转发配置节的类型为“forwarding”。主要选项如下：

| 名称   | 类型       | 含义描述                                                     |
| ------ | ---------- | ------------------------------------------------------------ |
| src    | 安全域名称 | 指定流量的源区域，必须指向一个已经定义的安全域的名称         |
| dest   | 安全域名称 | 指定流量的目的区域，必须指向一个已经定义的安全域的名称       |
| family | 字符串     | 协议家族（ipv4、ipv6 或者 any），默认值为 any，用于产生 iptables 规则 |

​		iptables 规则生成该部分依靠需要连接跟踪工作来生成状态匹配。在 src 和 dest 安全域至少需要有一个连接跟踪通过 MASQ 或连接跟踪选项启用。如果没有启用连接跟踪机制，那报文只能单向通过，返回的报文将被拒绝。

```
#允许局域网到广域网的报文转发
config forwarding
        option src 'lan'
        option dest 'wan'
```



### 6.2.4 redirect-重定向/端口转发/端口映射

​		目的地址转换（DNAT）定义在重定向配置节。  
​		在指定源安全域的所有进入的报文如果匹配给定的规则将重定向到指定的内部主机上。  
​		端口访问可以以“start:stop”来指定，例如 8080:8090，语法和 iptables 类似。  
​		对于设置这个规则，需要新老目的地址，并且可以选择源地址或者其他约束条件进行匹配。

| 名称      | 类型           | 含义描述                                                     |
| --------- | -------------- | ------------------------------------------------------------ |
| src       | 安全域名称     | 指定流量的源安全域。必须指向已经定义的区域，典型的端口转发通常是 wan |
| src_ip    | IP 地址        | 匹配从指定源 IP 地址的报文                                   |
| src_dip   | IP 地址        | 对于 DNAT 来说，匹配指定目的地址的报文；对 SNAT 来说，重写源地址为指定的地址 |
| src_mac   | MAC 地址       | 对于流入报文，匹配指定的 MAC 地址匹配                        |
| src_port  | 端口号         | 指定源端口或范围的流入报文                                   |
| src_dport | 端口号         | 报文的原始目标端口                                           |
| proto     | 协议名称或数字 | 匹配指定的协议                                               |
| dest      | 安全域名称     | 指出流量的目的安全域，必须是一个已定义的安全域的名称。对于DNAT 这个必须为 lan 域 |
| dest_ip   | IP 地址        | 对于 DNAT，将重定向到指定的内部主机，对于 SNAT，匹配给定 地址的流量 |
| dest_port | 端口号或范围   | 对于 DNAT 来说，重定向匹配的报文到内部主机的指定端口。对 于 SNAT 来说，匹配的报文将直接重定向到指定的端口 |

举例：

```
#从 wan 接口的 HTTP 请求报文到 IP 地址为 192.168.1.100、端口为 80 的 Web 服务器上，没有指定转换后端口号，那就是目的端口不变
config redirect
	option src 			wan
	option src_dport 	80
	option proto  		tcp
	option dest			lan
	option dest_ip		192.168.1.100
```



### 6.2.5 rule-规则（用来进行配置哪些端口允许访问）

​		用于定义基本的接受或拒绝规则来允许或限制你访问指定主机或端口，规则定义如下。  
​				①如果 src 和 dest 均指定，规则作用于转发流量  
​				②如果仅指定了 src，规则匹配流入本机的流量，即目的地址为防火墙的报文。  
​				③如果仅指定了 dest，规则匹配本机作为源地址的流量。  
​				④如果 src 和 dest 均没有给出，则默认作用于本机作为源地址的流量  

​		端口范围使用 start:stop，例如 8080:8090。这和 iptables 的语法完全一致。规则的配置 类型为“rule”，防火墙规则中如果指定了时间，则需要路由器的时间准确，否则和自己的 期望将完全不同。  
​		默认的防火墙配置是接受所有的局域网流量，但是阻断所有的 WAN 入口主动流量， 除了当前 NAT 或连接的被动流量。如果要打开服务的端口，可以像下图一样增加规则。

| 名称      | 类型                | 含义描述                                                     |
| --------- | ------------------- | ------------------------------------------------------------ |
| name      | 字符串              | 规则的名称                                                   |
| src       | 安全域名称          | 指定报文的来源，必须指向一个存在的安全域的名称               |
| src_ip    | IP 地址             | 匹配指定的源 IP 地址                                         |
| src_mac   | MAC 地址            | 匹配指定的源 MAC 地址报文，注意没有目的 MAC 地址匹配         |
| src_port  | 端口或端口范围      | 匹配指定的源端口或端口范围的报文。在协议号指定的情况下使用   |
| proto     | 协议名称或协议 数字 | 匹配指定的协议报文。可以是 UDP、TCP、TCPUDP、ICMP、GRE、IGMP或者 ALL。或者为代表这些协议的数字协议编号，编号含义来自文件/etc/protocols，数字零和 ALL 等价 |
| dest      | 安全域名称          | 指定流量的目的安全域。必须是一个已经存在的安全域名称。或者是*表示任 何安全域。如果指定了表示这个规则用于转发链，否则作用于INPUT链 |
| dest_ip   | IP 地址             | 匹配指定的目的 IP 地址报文，如果没有配置 dest 域，这条规则将当作INPUT 规则 |
| dest_port | 端口或端口范围      | 匹配给定的目的端口或端口范围                                 |
| target    | 字符串              | 匹配报文之后的行为（ACCEPT、REJECT、DROP、MARK 或NOTRACK）   |
| weekdays  | 星期列表            | 可以指定周一到周日的任何一天，可以组合起来，中间用空格隔开，例如：mon tue wed thu fri |

```
#将允许互联网上的主机通过 SSH 协议访问路由器
config rule
	option src			wan
	option dest_port	22
	option target		ACCEPT
	option proto		tcp
	
#阻止局域网主机到广域网主机 121.42.62.172 的全部连接。源主机将 收到目标端口不可达的 ICMP 消息
#就是把这个 IP 地址加入了访问黑名单，不允许访问
config rule
	option src			lan
	option dest			wan
	option dest_ip		121.42.62.172
	option target		REJECT

#创建一个输出规则，阻止从路由器ping IP 为 8.8.8.8 的主机。这个规则没有src字段，因此仅匹配从路由器发出的报文
config rule
	option dest			wan
	option dest_ip		8.8.8.8
	option proto		icmp
	option target		REJECT

#限制从局域网到广域网的目的端口为 1024～65535 的报文转发
config rule
	option src			lan
	option dest			wan
	option dest_port	1024-65535
	option proto		tcpudp
	option target		REJECT

```



### 6.2.6 include-包含自定义防火墙


​		include 用于包含自定义的防火墙规则。在防火墙配置中可以指定一条或多条 include配置节  
​		类型为“include”，仅有一个**必须的参数是包含的文件路径**，所有的可选参数如下表所示

| 名称    | 类型   | 含义描述                                                     |
| ------- | ------ | ------------------------------------------------------------ |
| path    | 文件名 | 指定自定义规则的路径，默认值为/etc/firewall.user             |
| enabled | 布尔值 | 为 1 表示启用，为 0 表示不使用，即可以不用删除规则定义，就可以这条规则不起作用，默认为启用 |
| type    | 字符串 | 指定 include 的类型，“script”表示是传统的 shell 脚本，“restore”表示是 iptables-restore 格式的文本 |
| family  | 字符串 | 指定这个包含规则的 IP 地址家族（IPv4、IPv6 或者 any）        |
| reload  | 布尔值 | 指定规则在重新加载时是否需要被再次调用，这仅在注入到内部规则时需要再次调用，因为内部防火墙规则链先被删除，然后再次创建 |

​		包括类型的脚本可以包含任意的命令，例如高级的 iptables 规则或流量整形所需的 tc 命令。  
​		由于自定义 iptables 规则要比一般的更具体，所以必须确保使用“-I”来插入而不是 一个“-A”来附加到最后，这样自定义规则将出现在默认规则的前面

## 6.3.常见用法

### 6.3.1.MAC 地址黑白名单

​		MAC 地址过滤是家用路由器的一个常见功能，它可以防止未授权的 MAC 地址访问路 由器和通过路由器访问网络。例如网络上有恶意用户，可以通过 MAC 地址限制指定恶意 用户主机连接到路由器，即使他拥有路由器的密码。  
​		OpenWrt 没有单独的 MAC 接入控制模块，但可以通过设置防火墙规则来实现。MAC 地址是计算机网卡的物理地址，它就像是网卡的身份证，在网络中进行通信时对网卡的 识别都是通过这个地址进行的。通常一个计算机仅有一个网卡，那这个网卡就可以代表 这个计算机，限制这个 MAC 地址即可控制计算机能否接入网络，从而有效控制了网络用户的上网权限

通常有两种方式来控制：白名单和黑名单  
		**黑名单**是指在名单内的设备不能接入网络。例如小孩的计算机不能访问  
		**白名单**是指名单内的设备可以接入网络，其他设备均不能访问 

实例：

```shell
#阻止指定客户端连接到因特网，第一个规则禁止黑名单访问网络
#第二个规则阻止从客户端连接路由器。这样该机器就不能通过该 OpenWrt 路由器访问 任何资源
config rule
	option src			lan
	option dest			wan
	option src_mac		08:00:27:00:58:AA
	option target		DROP
config rule
	option src			lan
	option src_mac		08:00:27:00:58:AA
	option target		https://bl paopln.netqg_41453285


```

如果以自定义规则来实现黑名单，则使用如下 4 条规则进行设置：
第一行首先定义了自定义链 MAC_FILTER，然后紧接着将 IPNUT 链的报文转到 MAC_FILTER，由它将匹配目标地址为路由器 IP 的报文。第三行规则将 FORWARD 链转 到 MAC_FILTER 自定义链中，这个将匹配经过路由器转发的流量。最后一个规则将源 MAC 地址的规则加入到 MAC_FILTER 链中。通常防火墙是默认允许局域网报文通过的， 因此可以仅设置拒绝通过的 MAC 即可

```
iptables -N MAC_FILTER
iptables -I INPUT -j MAC_FILTER
iptables -I FORWARD -j MAC_FILTER
iptables -A MAC_FILTER-m mac --mac-source 08:00:27:00:58:AA -j DROP
```

例如，某企业想要保证仅授权用户可以连接 Wi-Fi。因为通常 Wi-Fi 的连接密码只有一个，如果多个人访问，经常会导致密码透露给非授权用户。白名单技术就在这时派上用 场，将授权用户的 MAC 地址增加到防火墙中，这样即使 Wi-Fi 连接密码泄露，非授权用 户也不能通过无线路由器访问网络。如果要设置白名单模式，则需要在规则的最后增加一 个默认拒绝规则 

### 6.3.2.家长控制

​		OpenWrt 没有专门的家长控制模块，我们可以在防火墙功能中实现设置。例如， 禁止小孩在周一到周五上网，通过设置小孩专用的计算机 MAC 来禁止访问任何网络

```
#用于禁止指定 MAC 周一到周五将报文转发到互联网，weekdays 用来表示一 周中的第几天
config rule
	option src			lan
	option dest			wan
	option src_mac		28:D2:44:15:D5:A4
	option weekdays		'mon tue wed thu fri'
	option target		REJECT

```

​		在企业也是同样的情况，有些公司在工作的时间会禁止使用互联网，或者是根据公司 管理策略仅能访问一些授权的网站。这些策略最难的部分在于管理政策中哪些允许哪些不 允许，这通常很难做出决定。在技术上使用防火墙来实现，UCI 配置只能从 IP 层进行限 制，因此如果限制访问域名，需要转换为 IP 地址

```
配置实现了周一到周五的工作时间内禁止局域网用户访问网络，并允 许来自你自己 MAC 主机的网络访问
config rule
	option src			lan
	option dest			wan
	option src_mac		28:D2:44:15:D5:A4
	option target		ACCEPT
config rule
	option src			lan
	option dest			wan
	option src_ip		192.168.1.0/24
	option start_time	9:00
	option stop_time	18:00
	option weekdays		'mon tue wed thu fri'
	option target		REUECT
```

### 6.3.3.名词解释

​		**安全域**，是指相同安全等级的区域，由一个或多个接口组成，通常具有相同防火 墙规则

​		**黑名单**，是指不能通过的用户名单，名单以外的用户都能通过。

​		**白名单**，是指能通过的用户名单，名单之外的用户都不能通过

​		**家长控制**，是指家长限制孩子使用计算机网络的时间以及仅能访问限定的网络资源

## 6.4.  防火墙管理及调试

​		**①防火墙脚本目录**：`/lib/firewall`  
​		**②管理脚本**：`/bin/fw`  
​				格式：`/sbin/fw –help`  
​					`					/sbin/fw <command> <family> <table> <chain> <target> { <rules> }`  
​		**③启机脚本**：`/etc/init.d/firewall`  
​				restart 重启生效。  
​				stop  手动停用防火墙（删除所有规则并设置默认策略为接受）。  
​				start  手动启动防火墙。  
​				disable 永久禁用，需重启生效(禁用并不会删除已生效规则)。  
​				enable  重新激活防火墙  
​		**④删除规则：**  
​				1>找出索引： `iptables -L -t raw --line-numbers`  
​				2>删除规则： `iptables -t raw -D OUTPUT 3 （删除OUTPUT链的第三条规则）`  
​		**⑤调试产生的规则集：**    
​				观察通过防火墙程序产生的 iptables 命令是非常有用的，跟 踪防火墙重启的 iptables 错误，或者验证特定 UCI 配置规则的结果及作用。  
​				为了看到执行过程中的规则，运行 fw 命令之前将` FW_TRACE `环境变量设置为`1`。  
​				FW_TRACE 变量使用在`/lib/firewall/fw.sh `中，判断是否定义，如果已经定义，将输出执行的每条规则：    
​								 `FW_TRACE=1 fw reload`  
​				将执行输出重定向到一个文件中供以后分析，使用以下命令： `FW_TRACE=1 fw reload 2>/tmp/iptables.log `  
​				在 OpenWrt 15.05 版本中防火墙使用 C 语言来重新实现，编译安装后为 fw3，使用**“-d”**选项来进行输出 iptables 命令。还有另外一个命令也支持输出防火墙规则： `fw3 print`

 		**⑥测试防火墙：**

​		防火墙规则配置越多，它就越复杂。在正式使用之前，首先需要对配置进行测试。在配置修改完成后，需要调用以下命令来重启防火墙：`/etc/init.d/firewall restart`  
​		对于目标进行测试可以有非常方便的目标地址测试，但是如果有黑名单或者时间 控制，就比较麻烦。测试时间需要你改变路由器系统时间进行测试，或者等待足够长的 时间。  
​		对于网络是否正常，可以使用 ping 命令进行进行测试。对于端口是否开放，可以用 NetCat 工具进行验证，NetCat 请参考在“测试工具”中描述的技术.
