# 1.防火墙

## 1.1. 概念

​		“防火墙”（Firewall）术语来自建筑设计领域，是指用来起分割作用的墙，当某一部分着火时可以减缓或保护其他部分免受火灾影响。在计算机网络中，**防火墙是在两个或多个网络之间用于设置安全策略的一个或多个系统的组合**。  
​		防火墙起到隔离异常访问的作用，仅允许可靠的流量通过，从而保护了家庭和企业内部网络信息的安全。  
​		Linux防火墙通常包含两部分，分别为：  
​				①**netfilter**：内核空间，执行报文过滤规则。  
​				②**iptables**：用户空间，管理防火墙规则的命令行工具集，通过该工具与内核打交道将防火墙规则写入内核中，常被统称Linux防火墙，是一个报文状态检测防火墙。这意味着防火墙内部存储每一个连接的信息，并且可以将每一个报文关联到它所属的连接。这个信息非常有用，它用于自动打开响应报文的传输路径，因此在创建防火墙规则时，通常没有必要创建相反方向的防火墙规则，防火墙将自动计算出这个规则。

​		下图是一个典型的防火墙部署结构：

![img](file:///C:\Users\acer\AppData\Local\Temp\ksohtml25032\wps1.jpg)

## 1.2.防火墙规则

### 1.2.1 防火墙的表包含：

​		①**filter**: 	  **过滤表**，完成报文过滤。  
​		②**nat**:   	   **网络地址转换表**，完成源/目的地址和端口的转换。  
​		③**mangle**:  **修改表**，完成报文修改。  
​		④**raw**:		 **原始表**，完成配置连接跟踪。

​		⑤**security**：安全Linux防火墙规则。

### 1.2.2 一个防火墙规则包含：

​		①**报文匹配规则**：用于检测报文是否符合该规则标准。  
​				每个防火墙的表又包含了很多规则链，每个表中的规则链名可能相同，但任务是不同的，报文按照一定顺序进入规则链中进行检查是否符合规则。  

​		②**处理目标**：对匹配的规则进行处理的方式（前四个为系统内置处理目标）  
​				ACCEPT (接收)、DROP(丢弃)、QUEUE(入队)、RETURN(返回)、REJECT(拒绝)、DNAT（目的网络地址转换）、SNAT（源网络地址转换）、MASQUERADE（伪装）、LOG、REDIRECT

| 命令                                                         | 功能描述                                                     | 备注                                                         |
| ------------------------------------------------------------ | :----------------------------------------------------------- | ------------------------------------------------------------ |
| **iptables -h**                                              | 显示帮助                                                     |                                                              |
| **iptables -t nat -n -L**                                    | 查看网络地址转换规则                                         | -n 是为了避免长时间的DNS解析                                 |
| **iptables -F**                                              | 清空整个防火墙/所选的规则链中的规则，未指定链则清空默认表中所有链规则 | 如：清空 filter 表中 INPUT 链的规则iptables -t filter -F INPUT |
| **iptables -P {chain} {policy}**                             | 默认策略设置。<br />策略：用于处理相应规则链中没被规则匹配的报文 | 如：设置输入链为默认拒绝iptables -P INPUT DROP               |
| **iptables -N**                                              | 自定义规则链的创建                                           | 如：iptables  -N UDP_FILTER                                  |
| **iptables -A --append**                                     | 将防火墙规则增加到所选规则链的末尾                           |                                                              |
| **iptables -D --delete**                                     | 在指定的规则链中删除规则。<br />①指定规则号来删除<br />②通过规则匹配来删除。 | 规则编号是指规则在规则链中的顺序号，从 1 开始增加。<br />注意：规则在规则链中的规则编号不是固定的，如果删除前面的规则，则后面的规则自动往前移动 |
| **iptables -I, --insert chain [rulenum] rule-specification** | 插入到规则链中的指定位置，如果不指定插入位置，则插入到规则链的第一个位置处 |                                                              |
| **iptables  -L，--list [chain]**                             | 查看防火墙规则，如果没有指明规则链，则所有的规则链均显示出来。 |                                                              |
| **iptables -n**                                              | 数字格式显示ip和端口                                         |                                                              |
| **iptables --line-numbers**                                  | 显示行号                                                     |                                                              |
| **iptables -x**                                              | 显示精确值，不要做单位换算                                   |                                                              |
| **iptables -t {table}**                                      | 指定表                                                       |                                                              |
| **iptables -v/-vvv/-vvvv**                                   | 显示详细信息                                                 |                                                              |
| **iptables -X**                                              | 删除自定义空链，若链内有规则则无法删除                       |                                                              |
| **iptables -Z**                                              | 计算器清零                                                   |                                                              |
| **iptables -E**                                              | 重命名自定义链                                               |                                                              |
| **iptables -R [n]**                                          | 替换规则链中的指定位置的规则                                 |                                                              |
| **iptables -s/ --src /--source**                             |                                                              |                                                              |
| **iptables -d**                                              |                                                              |                                                              |
| **iptables -i**                                              | 指定数据报文流入接口                                         | input prerouting forward                                     |
| **iptables -o**                                              | 指定数据报文流出接口                                         | output postrouting forward                                   |
| **iptables -p**                                              | 明确说明只放行哪种协议的报文匹配规则                         |                                                              |