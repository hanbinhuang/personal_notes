[TOC]



# 1. dnsmasq组件

## 1.1. 简介

### 1.1.1 dnsmasq整体简介

​		**①引入：**家庭和小型企业网络，当多人同时上网时，客户机经常进行DNS查询，大多查询会是重复的域名，若有一个 DNS缓存代理服务于局域网，这样将减少DNS的因特网存取，加快DNS访问速度和节省网络流量，dnsmasq就是在这种情况下应运而生。

​		**②作用**：轻量级DHCP、TFTP、DNS缓存服务器,用于小型网络提供DNS和DHCP服务。  
​				判断LAN网络是否需要提供DHCP server功能，如果需要则添加DHCP相关规则配置  

​		**③工作原理：**dnsmasq接收DNS请求，并从本地缓存中读取，若缓存不存在就转发到一个真正的递归 DNS 服务器。也可以读取`/etc/hosts`的内容，这样就可以对局域网的主机查询进行DNS查询响应，这些局域网的主机名称不会暴露在全局DNS域中

​		**④配置文件：**`/etc/config/dhcp`  
​				该文件控制着DNS和DHCP服务选项。  
​				默认配置：  
​						<1>一个通用的配置节来指定全局选项。  
​						<2> 一/多个DHCP来定义动态主机配置服务的网络接口和地址池等。  
​						<3> 包含多个域名和主机配置，并且提供客户端地址列表来查询

​		**⑤文件工程目录**

### 1.1.2. dnsmasq dns简介

openwrt的dns由dnsmasq（dns server 和 dhcp server的合并）实现，默认配置为dns转发模式。  
		wan口为dhcp client， 则dhcp server在启动时，将上级路由的ip，作为本路由的nameserver，实现dns转发。  
		lan口为dhcp server，因此，下级设备自动获取的nameserver即为本路由的ip地址。



### 1.1.3. 文件

**1>/tmp/resolv.conf.auto：**  

![image-20230310083541122](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230310083541122.png)

分析：sta首先请求本地配置的dns server(自动获取：192.168.95.1)中查询360的ip（dns查询顺序忽略），该包到达ap的lan口后，转发到ap的wan口。ap的wan口，根据resolv.conf.auto的配置，转发到192.168.1.1上获取。192.168.1.1收到该包后，请求本地dns server（一般为isp提供），获取360的ip。结果按照原路返回给sta。

**<2>/tmp/resolv.conf**：

​	**来源：**不明，没有深究。  
​	**作用：**当lan口有包请求dns时， foward到该地址上，从该处获取dns。  
​	**实例：**

![image-20230310083644219](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230310083644219.png)

当我们在终端时ping 某一个地址时，该地址在公网和内网都有一个ip地址对应：

 **分析**：当我们在终端ping时，即直接从lan口发包时，匹配resolv.conf里面的nameserver，返回一个内网地址。通过其他测试，我得出一个额外结论，仅当resolve.conf没有配置时，会再次匹配resolv.conf.auto 返回公网地址，配置错误不会再次匹配。  
**常见配置**：  
		**①nameserver**：用于配置名字服务器，最多可以设置 3 个名字服务器，每一行一个。 如果有多个名字服务器地址，解析库将按照列表顺序查询。若第一个名字服务器查询超 时，再顺序查询下面的名字服务器，直到所有的名字服务器都尝试一遍。如果没有名字服务器地址或者这个配置文件不存在，则默认使用本机（127.0.0.1）作为名字服务器 地址。  
		**②domain**：可以使用相对于本地域名的短名来查询。如果域名没有配置，则返回主机名。  
		**③search**：search 定义域名的搜索列表，当要查询没有域名的主机时，将在由 search 声明的域中分别顺序进行查找，是只有使用短名时所要附加的域名后缀。domain 和 search 不能共存，如果同时存在，后面出现的将覆盖前面的定义

**resolv.conf与resolv.conf.auto的结论：**

​		①在lan口直接ping时，读取resolv.conf的内容，作为dns server，若resolv.conf为空，再读取resolv.conf.auto的内容作为nameserver。  
​		②在sta上ping时， lan口直接转发到wan口，读取resolv.conf.auto的内容作为nameserver。  

**<3>/etc/resolv.conf：**配置文件会软链接到/tmp/resolv.conf  



**<1>/etc/hosts**：记录本地主机名（主机系统）？  
**<3>/tmp/dhcp.leases：**记录已被分配的地址？    
**<6>/var/etc/dnsmasq.conf：**dnsmasq相关配置？  

/etc/config/dhcp

/etc/init.d/dnsmasq restart ==> /etc/config/dhcp + /etc/dnsmasq.conf ==> /var/etc/dnsmasq.conf




## 1.2. 配置文件参数介绍

### 1.2.1. 具体配置

![image-20230309090236471](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230309090236471.png)

### 1.2.2. 全局配置

```shell
config dnsmasq
        option domainneeded '1'					#不会转发针对不带点的普通文本的A或AAAA查询请求到上行的域名服务器。如果在/etc/hosts和 DHCP中没有该名称将直接返回“not found”
        option boguspriv '1'					#所有私有查找如果在/etc/hosts没找到，将不转发到上行DNS服务器
        option filterwin2k '0'					#不转发公共域名不能应答的请求
        option localise_queries '1'				#如果有多个接口，则返回从查询接口来的接口网络的主机IP地址。在同一主机有多个IP地址时非常有用，返回查询网段的IP地址，这样源主机和目标主机通信是将不会跨越路由器
        option rebind_protection '0'
        option rebind_localhost '1'
        option local '/lan/'
        option domain 'lan'
        option expandhosts '1'					#在/etc/hosts 中的名称增加本地域名部分
        option nonegcache '1'					#在通常情况下，“no such domain”也会缓存，下次查询时不再转发到上游服务器而直接应答，这个选项将禁用“no such domain”返回的缓存
        option authoritative '1'				我们是局域网的唯一的 DHCP服务器，当收到请求后会立即响应，而不会等待，如果拒绝的话也会很快拒绝
        option readethers '1'					#从/etc/ethers文件中读取静态分配的表项。格式为硬件地址和主机名或IP地址，当收到SIGHUP信号时也会重新读取
        option leasefile '/tmp/dhcp.leases'
        option resolvfile '/tmp/resolv.conf.auto'#指定一个DNS配置文件来读取上游域名服务器的地址
        option concurrent_state '1'
        option add_local_hostname '0'
        option nodnsra '1'
        option ignorenx '1'
        option dnsforwardmax '512'
```

![image-20230309090539198](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230309090539198.png)

### 1.2.3. DHCP地址池配置

​		类型为dhcp的配置节指定了每一个接口的DHCP设置，通常最少有一个服务于局域网接口的dhcp配置设置,配置选项如下：

```shell
config dhcp 'lan'
        option interface 'lan'		#表示服务的网络接口，这个接口名称是network中配置的虚拟接口
        option start '1'			#分配IP的起始地址
        option limit '254'			#地址空间范围，默认为150
        option leasetime '30m'	#DHCP分配IP地址的租期, start和 limit在生成dnsmasq的配置文件时进行组合为dhcp-range
        option ignore '0'			#dnsmasq将忽略从该接口来的请求
        option force '1'			#强制指定接口上的DHCP服务
        
config dhcp 'wan'
        option interface 'wan'		#表示服务的网络接口，这个接口名称是network中配置的虚拟接口
        option ignore '1'			#dnsmasq应忽略此池
```

### 1.2.4. 域名配置 （Custom Domain）

​		dnsmasq 支持自定义主机/自定义域名，使用 domain 配置节来管理自定义域名，配置选项如下：

| 名 称 | 类 型  |                 含 义                  |
| :---: | :----: | :------------------------------------: |
| name  | 字符串 | 主机的域名，这个域名将不在因特网上查询 |
|  ip   | IP地址 |            域名对应的P地址             |

​		**实例：增加自定义域名记录**  
​				增加domain匿名的配置节， 然后设置其名称和 IP 地址并且提交。记录被写到`/etc/config/dhcp`文件中，但现在功能并未生效。调用重启 dnsmasq 进程命令来使 dnsmasq 读取这些配置更改 /`etc/init.d/dnsmasq restart`，之后便可以通过域名访问IP，与主机系统功能完全相同，只不过主机系统仅可在本机访问，而加载这里可服务与家庭网。

```shell
root@Ruijie:/# uci add dhcp domain							
cfg04f37d
root@Ruijie:/# uci set dhcp.@domain[-1].name="huang"
root@Ruijie:/# uci set dhcp.@domain[-1].ip="192.168.6.6"
root@Ruijie:/# uci commit dhcp
root@Ruijie:/# /etc/init.d/dnsmasq restart

config 'domain'
    option 'name' 'huang'
    option 'ip'   '192.168.6.6'
```

### 1.2.5. 主机配置（Static Leases\静态租约）

​		DHCP 在分配 IP 时，选择一个未使用的 IP 地址进行分配。假定有一个服务器，也是通过DHCP 进行 IP 分配的，这样每次重启后分配的 IP 地址可能发生改变，这在访问服务 器时还需查看其 IP 地址。根据 MAC 地址分配固定 IP 地址可以解决这个问题。在 DHCP 配置文件中使用 host 来配置

| 名 称 | 类 型  |                       含 义                        |
| :---: | :----: | :------------------------------------------------: |
|  ip   | 字符串 |                客户端所获得的IP地址                |
|  mac  | 字符串 |                 主机的网卡MAC地址                  |
| name  | 字符串 | DHCP客户端所获取到的主机名称，是否使用由客户端决策 |

​		**实例：根据MAC增加固定IP**  

​		通过 uci 命令进行增加（这将增加固定的 IP 地址 192.168.6.100。然后重启 DHCP 服务器，这时 MAC 地址为 “08:00:31:8d:88:e1”的计算机再次获取的 IP 地址将设置为固定 IP 地址 192.168.6.100，主机 名称设置为 buildServer）

```shell
root@Ruijie:/# uci add dhcp host							
cfg05fe63
root@Ruijie:/# uci set dhcp.@host[-1].ip="192.168.6.100"
root@Ruijie:/# uci set dhcp.@host[-1].mac="08:00:31:8d:88:e1"
root@Ruijie:/# uci set dhcp.@host[-1].name="buildServer"
root@Ruijie:/# uci commit dhcp
root@Ruijie:/# /etc/init.d/dnsmasq restart

config host
        option ip       '192.168.6.100'
        option mac      '08:00:31:8d:88:e1'
        option name     'buildServer'
```



### 1.2.6. DHCP客户端信息

​		DHCP 还有一个功能是记录客户端列表。客户端列表显示当前所有通过 DHCP 服务器 获得 IP 地址主机的相关信息，包括客户端主机名称、MAC 地址、所获得的 IP 地址及 IP 地址的有效期。表 11-5 列出了所有保存字段的含义，我们可以通过`/tmp/dhcp.leases` 文件来 查看所有通过 DHCP 服务器获得 IP 地址的计算机信息，配置选项如下：

|      类别       |                            含 义                             |
| :-------------: | :----------------------------------------------------------: |
| 有效时间（租期) | 指客户端计算机获得IP地址的有效时间，是指从1970年开始的一个秒值，到<br/>这个时间之后地址将失效，客户端软件会在租期到期前自动续约 |
|     MAC地址     |              获得IP地址的客户端计算机的MAC地址               |
|     IP地址      |             DHCP服务器分配给客户端计算机的P地址              |
|   客户端名称    |            显示获得IP地址的客户端计算机的主机名称            |

## 1.3. 主机系统

### 1.3.1. 简介

​		**host文件：**在主流的操作系统上，均有一个hosts的配置文件，这个配置文件的主要作用是定义 IP 地址和主机名的映射关系，这个配置可以使用文本编辑器打开并进行编辑。（在Windows操作系统也有一个类似这样的文件，其位置为 C:\Windows\System32\Drivers\etc\hosts）

​		**工作原理：**当用户在浏览器中输入所想访 问的网址时，系统首先从这个hosts文件中查找域名的IP地址，如果找到就打开 IP 地址 的网页，如果没有找到就向 DNS 服务器进行查询

### 1.3.2. host文件

​		**<1>文件路径**：`/etc/hosts`  
​		**<2>简介**：主机名的静态查询表，用于保存主机名与IP之间的对应关系（普通文本文件）。  
​		**<3>格式**：一个 IP 地址占用一行， 每一个主机关联一个IP地址（各个域之间用空格或制表字符分开）。格式如下：  
​					127.0.0.1 localhost [aliases...]   
​		**<4>作用**：主流的现代操作系统中，主机系统表已经很少使用，已经被域名查找机制 DNS 取代，但它仍广泛地使用在以下 5 个场景：  
​				**①本地主机信息：**启动中。大多数系统都包含名称和地址为本地网络上的信息主机信息表。这是非常有用的，因为在系统启动时 DNS 解析库还没有装载到内存中，如：  

```shell
127.0.0.1		localhost
192.168.1.1		bjbook.net		server
192.168.1.100	openwrt.bjbook.net		openwrt
```

​				**②DNS输入**：网络信息服务站点使用主机表作为 DNS 服务主机数据库的输入，或者使用主机表作为备用配置  
​				**③加快域名解析，节省网络流量：**hosts 文件在主机上配置具有加快域名解析的作用， 对于经常访问的网站和主机，我们可以在 hosts 文件中配置域名和 IP 的对应关系。由于有了映射关系，当我们访问域名时，可以直接从 hosts 文件中解析得出，而不用访问网络上 的域名服务器，不用消耗网络流量  
​				**④屏蔽网站（域名重定向）**：屏蔽广告网站，有很多网站带有广告，但广告和网站 本身域名不同，因此如果能屏蔽一些众所周知的广告网站域名，这样我们利用 hosts 把这些广告的网站的域名映射到本机 IP 或非法目的 IP，这样就不会看到这些广告图片了,也不 会浪费网络流量。例如：（这样计算机解析域名 a.com 时，就解析到错误的 IP，达到了屏蔽广告网站的目的）

```
127.0.0.1 a. com
```

​				**⑤防止DNS污染和DNS劫持**  
​						**1>DNS 劫持**就是攻破了 DNS 服务器防护，从而获得 域名解析记录的控制权，进而修改域名解析的结果。这将导致对原始域名的访问转到另外 的 IP 地址。  
​						**2>DNS 污染**是因为 DNS 查询没有任何认证机制，而且 DNS 查询通常采用的 UDP 是无 连接不可靠的协议，因此 DNS 的查询非常容易被篡改：通过对 UDP 端口 53 上的 DNS 查 询报文进行分析，一旦发现与关键词相匹配的请求则立即伪装成目标域名的解析服务器给 查询者返回虚假结果。  
​				如果我们已知服务器的 IP 地址，就可以在 hosts 文件中设置正确的 IP 地址，从而避免 DNS 劫持和污染

# 2. DHCP相关

​		DHCP = Dynamic Host Configuration Protocol = 动态主机配置协议。  

## 2.1. 引入

​		在 TCP/IP 网络上，每台主机在访问网络及其资源之前，都必须进行基本的网络信息配置，包含 IP地址、子网掩码、默认网关和 DNS 等。在大型网络中，如果每台终端主机的地址都由不同的使用者来分配，那么就很容易出现地址相同的情况。对于经常移动的终端，重新配置可能需要很长时间，并且容易出错，如果 IP 配置错误将会导致不能访问网络。因此需要一种机制来简化主机 IP 地址的配置。动态主机配置协议 DHCP 应运而生。  
​		采用 DHCP 的好处在于减少了网络管理员和用户的负担。这将可以减少手工配置 IP 地址导致的地址冲突，以及网关地址或 DNS 地址错误导致的不能访问网络等问题

## 2.2. 简介

**（1）DHCP功能：**   
		通常被应用在**局域网**中，主要是为了**集中管理**以及**降低客户端的配置和维护成本**。

**（2）DHCP服务器功能：**

​		DHCP服务器可为网络上的每个设备**动态分配IP地址、子网掩码、默认网关地址，域名服务器(DNS)地址和其他相关配置参数**，以便可以在网络中进行通信，提高地址利用率，减少管理员手动分配IP的麻烦。  
​		DHCP协议由RFC 2131定义，采用**C/S通信**模式，由客户端向服务器提出配置申请，服务器返回为客户端分配的配置信息。  
**（3）DHCP Snooping**  
​		在企业、政府办公室场景中，由于网络没有部署WiFi或网口不够用，办公人员为了手机等无线终端可以上网或连接更多的设备，就自己购买小路由并私接到办公室的墙插网口或交换机上面。   
​		如果接入的是小路由的WAN口还好，一旦接入的是LAN口，就会出现小路由自动给网络中的上网终端分配错误ip的情况，被分配到错误ip的终端无法上网，同时由于私接小路由乱分配IP也会导致地址冲突，严重的会造成整网中断，而且网管人员也很难找到私接路由的办公室或交换机网口，网络故障排查费时费力
这时就需要支持DHCP-SNOOPING功能的交换机预防与高效定位解决这个问题

## 2.3. DHCP原理

​		DHCP 服务器拥有一个 IP 地址池，当任何启用 DHCP 的客户机连接到网络时，可从服务器那里租借一个 IP 地址，不再使用的 IP 地址自动回收到地址池中，供再次分配使用。  
​		DHCP 保证同一时刻的任何 IP 地址只能分给一个客户机使用。当 DHCP 客户机重新启动时，应配置为相同的 IP 地址。在 DHCP 服务器重启的情况下，也应当给每一个客户机分配相同的 IP 地址，并且和手动分配的 IP 地址共存。这要求 DHCP 服务器对已分配的 地址进行保存，并且在客户端不使用时进行回收.  
​		DHCP 是一种动态地向网络终端提供配置参数的协议。在终端提出申请之后，DHCP 服务器可以向终端提供 IP 地址及子网掩码、网关和 DNS 服务器地址等参数。  
​		DHCP 协议基于 UDP 协议，客户端的端口号是68，服务器的端口号是67

## 2.4. 地址分配机制

​		DHCP服务器提供两种地址分配机制，网络管理员可以根据网络需求为不同的主机选择不同的分配策略。  
**（1）动态分配机制：**  
​		通过DHCP为主机分配一个有使用期限（这个使用期限通常叫做租期)的IP地址。  

**（2）静态分配机制：**  
		网络管理员通过 DHCP为指定的主机分配固定的IP地址。

## 2.5. DHCP报文

​		DHCP的请求和应答封装在UDP报文中。  
​		传输层使用 UDP 协议，使用两个固定的端口号，服务器使用 67，客户端使用 68。这 样可以非常方便地区分是请求还是响应。  
​		IP 层在请求 IP 地址时采用链路层广播，链路层广播地址为“FF:FF:FF:FF:FF:FF”。网络层目的 IP 使用广播地址 255.255.255.255，源地址采用 0.0.0.0，这是因为请求时自身没有 IP 地址，并且不知道服务器的 IP 地址。

![image-20230310091833623](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230310091833623.png)

**①报文类型** ：1表示请求，2表示应答  
**②硬件类型、硬件地址长度**：硬件类型字段为1表示以太网，以太网的硬件地址长度为 6 字节。  
**③跳数**：字段由客户端设置为 0，如果和 DHCP 服务器之间有中继器的话将被修改。  
**④事务ID**： 是一个由客户端设置并由服务器返回的 4 字节整数。客户机使用它对 请求和应答进行匹配。对于每个请求客户端首先将该字段设置为一个随机数.  
**⑤秒数：**客户端开始 进行 DHCP 请求时，将“秒数”字段设置为一个时间值。服务器能够看到这个时间值，备用服务器在等待时间超过这个时间值后才会响应客户的请求，这意味着备用服务器接管 DHCP 服务  
**⑥flags：**是保留值，设置为0.  
**⑦一系列IP地址字段：**客户端 IP 地址字段填 0，如果上次成功配置过 IP 地址，它将写到“客户端 IP 地址” 字段。服务器返回应答时将该客户的 IP 地址写入“你的 IP 地址”字段，并将自身 IP 地址 填写到“服务器 IP 地址”字段。在同一网络中继地址填0  
**⑧客户端MAC地址**：填写网卡硬件地址，不足部分填0  
**⑨服务器主机名：**服务器主机名字段由服务 器来填写，通常为 0。  
**⑩引导文件名：**引导文件名字段用于填充 TFTP 下载的文件全路径，通常用于无盘 启动工作站  
**①可选字段**：选项字段用于扩展，但实际上有一些选项在终端节点接入互联网时是必须的。 这些包含 DNS 地址、网关地址和子网掩码等可选字段部分均以 TLV（类型-长度-值）来表示  
**子网掩码选项**用于指定客户端的子网掩码。子网掩码的类型码为 1，长度为 4 字节  
**路由选项**指定了客户端子网的下一跳地址。如果有多个，路由器将按照优先顺序排列， 一般为路由器自身 IP 地址。类型码为 3，长度为 4 的倍数  
**域名服务器选项**用于将名字服务器提供给客户端，并且以优先顺序给出，选项代码为 6，最小长度为 4 个字节，并且是 4 的倍数

## 2.6. DHCP工作流程

DHCP 通常由客户端发起广播请求，服务器收到请求后在配置文件中查询，如果符合 要求则向客户端提供服务

下图所示为DHCP配置IP地址的报文流程

![img](file:///C:\Users\acer\AppData\Local\Temp\ksohtml10952\wps2.jpg) 

①客户端在以太网上广播“DHCP Discover”报文来发现 DHCP 服务器  
②IP 为 10.0.2.2 的服务器收到广播请求后，向客户端回应请求，发出单播“DHCP Offer”报文，并且目的 IP 为 10.0.2.15  
③客户端再次以广播形式发出“DHCP Request”报文。这是因为客户端可能收到多 个服务器“DHCP Offer”报文，客户端会根据报文的内容来选择一个给予响应，采用广播 形式可以让多个服务器均可收到  
④当服务器收到“DHCP Request”报文后，服务器在将客户端的 MAC 地址同分配 的 IP 地址绑定后，将 IP 信息（IP、掩码、网关地址和 DNS 等）发送给客户机  
⑤客户机收到“DHCP ACK”报文后，将 IP 信息设置到主机系统上。这时 IP 设置 就完成了，客户机就可使用 IP 来访问网络了



# 3. DNS相关

​		DNS = Domain Name System = 域名解析系统

## 3.1. 由来

​		**主机系统**适合小型网络等一些特殊的场景。在因特网中，主机地址非常庞大，并且主机的IP地址经常改变，因此使用**域名系统 DNS** 代替主机系统DNS 可以被视为一种用于 TCP/IP 应用程序的分布式数据库，它提供主机名字和 IP地址间的相互转换。这里提到的分布式是指在因特网上的单个站点不能拥有所有的信息。每个站点（如大学中的系、校园、公司或公司的部门）保留它自己的信息数据库，并运行一 个服务器程序供因特网上的其他系统查询。

​		TCP/IP提供了通过IP地址来连接到设备的功能，但对用户来讲，记住某台设备的IP地址是相当困难的，因此专门设计了一种字符串形式的主机命名机制，这些主机名与IP地址相对应。在IP地址与主机名之间需要有一种转换和查询机制，如：  
​				www.baidu.com     -DNS解析->  14.215.177.39 (IP地址)  
​				www.qq.com           -DNS解析->  121.14.77.201 (IP地址)  
​				www.taobao.com   -DNS解析->   117.24.3.233(IP地址)

## 3.2.域名结构

![image-20230310084402981](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230310084402981.png)

​		最顶端有一个未命名的根节点，然后其下分为好几个基本类别名称（称 为顶层域名），例如 com、org、net 和 gov 等 3 字符域名，还有 cn、sg、jp 和 us 等两个字符国家地区域名  
​		每个节点有一个至多 63 个字符长的标识，域名总长度则不能超过 253 个字符。命名标识中不区分大写和小写  
​		命名树上任何一个节点的域名就是将从该节点到 最高层的域名串连起来，中间使用一个点“.”分隔这些节点。例如，一个完整的域名为 www.bjbook.net  
​		域名树中的每个节点必须有一个唯一的名称，但域名树中的不同层级节点可使用相同的标识，只要在不同的父节点下即可.

## 3.3. DNS缓存与查询

**（1）DNS缓存:**  
		用于记录域名与其映射的IP地址的关系的数据表。利用DNS缓存可以减少域名访问的时延。

**（2）DNS查询的类型:**  
		**① 递归查询**，只需要发出一次请求，就能得到相应的结果。  
		**② 迭代查询**，需要经过多次挨个查询，才能得到相应的结果。

**（3）常见DNS服务器:**  
		114 DNS: 114.114.114.114  
​		Google DNS: 8.8.8.8

## 3.4. DNS解析过程

​		(0)PC首先查询主机执行流程，查询hosts文件是否有对应域名配置，若文件无该域名则从resolv.conf文件中取出域名服务器地址发起域名查询。	  
​		(1) PC(无DNS缓存)想要访问一个新的网址，首先需要发送DNS请求报文给本地的DNS服务器。  
​		(2) DNS服务器会去查找自己的缓存。无论查找到或者没有查找到都会返回一个应答报文给PC。   
​		(3)  PC根据收到的DNS响应报文进行判断是否能访问。

![image-20230303092502447](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230303092502447.png)

**实例：**  
**①没有/etc/resolv.conf 配置文件**：  
		解析库默认向本机（127.0.0.1）发起域名查询，因 OpenWrt 本身带有 dnsmasq 提供服务，因此可以返回响应。  
**②配置多个域名服务器地址**：  
		resolv.conf 配置如下：

```shell
nameserver 59.108.61.61
nameserver 219.232.48.61
```

 ping 163.com：首先向第一个服务器 59.108.61.61发起查询163.com 的 IP 地址，如果查不到将使用下一个域名服务器来进行查询。  
**③配置有domain**  
		resolv.conf 配置如下：

```shell
domain bjbook.net
nameserver 8.8.8.8
```

​		这种情况下如果访问完全合格域名，则直接向域名服务器发起查询；如果不是完全合格域名，则首先在 hosts 文件中进行查找，如果在 hosts 文件中找不到主机名的 IP 地址，则再向名字服务器发起查询请求。如果是不带点的字符串，则加上域名后缀向名字服务器发起查询请求，如果中间带有点，则认为是一个域名， 将不用加上域名后缀，直接使用该字符串向名字服务器发起请求：    
​		①执行“ping 163.com”命令，首先在 hosts 文件中查询主机 163.com 的 IP 地址， 如果查不到将直接向名字服务器查询 163.com 的 IP 地址，找到后向目的 IP 发起 ICMP 请求  
​		②执行“ping openwrt”命令，首先在 hosts 文件中查询主机 openwrt 的 IP 地址，如 果查不到将拼接域名后缀“bjbook.net”，然后向名字服务器查询 openwrt.bjbook.net 的 IP 地址，找到后向目的 IP 发起 ICMP请求

## 3.5.DNS报文格式

​		DNS采用客户机/服务器模型。DNS默认使用TCP和UDP端口 53。DNS的请求和应答封装在UDP报文中。

![image-20230310084638174](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230310084638174.png)

**①会话标识**：报文头部的会话标识字段由客户端生成随机值填充并由服务器原样 返回。客户端通过该字段来匹配请求和响应  
**②flags**：flags部分非常复杂，如果是请求一般为0x0100。如果为响应，通常有两种情况：0x8182表示服务器失败；0x8180表示服务器 成功响应。  
**③问题数目、回答资源记录数、授权资源记录数目、额外资源记录数目**：对于查询报文，问题数目通常是1，而其他3项则均为0。对于应答报文，问题数目还是1，回答数至少是1  
**④问题**：问题部分中每个问题的格式由 3 部分顺序组成：查询内容、类型（Type）和类（Class）。 类型和类均为固定的两个字节长度。查询内容长度不定，它是一个或多个标识符的序列。每个标识符以首字节的计数值来 说明随后字符串的字节长度，每个名字的最后字节为 0 表示结束。计数字节的值必须是 0～ 63 的数字，因为标识符的最大长度为 63。高位字节为二进制 11 时，用于压缩格式，指向 报文的查询字符串位置，字符串位置是从 DNS 报文头部开始计算的。     
**⑤回答资源记录、授权资源记录、附加信息资源记录**：DNS 报文中最后 3 个字段分别为回答字段、授权字段和附加信息字段，均采用资源记 录（Resource Record，RR）格式。资源记录格式内容顺序包含域名、类型、类、生存时间、 数据长度和数据6部分。  
		如下图所示：域名是记录中资源数据对应的名字。它的格式和前面介绍的查询名字段格式相同。类 型和类与问题域内容格式相同。生存时间字段占4个字节，是客户程序保留该资源记录的 秒数，这里已转换为 15 分钟。资源数据长度占两个字节长度。数据部分的格式依赖于类型字段的值，这里的资源数据是4字节的IP地址。

![image-20230310085012685](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230310085012685.png)

## 3.6. DNS相关指令

### 3.6.1. nslookup

**（1）作用：**  
		用于查询DNS的记录，查看域名解析是否正常，在网络故障的时候用来诊断网络问题。		

（2）

# 4.IP与NAT

## 4.1. IP概念

​		**（1）IP地址概念**：4G,以太网，WLAN..这些多种的链路接入方式，需要网络层才能互相打通。在网络层，每台入网设备都规定了一个唯一的地址。
现有主流的IPv4只有4段数字，每一段最大不超过255所以只有大约43亿个地址。

​		**（2）IP地址分类**：IP地址分为**公网(Public)**和**私网(Private)**。  
​				**①公网**：只有拥有公网IP，才能接入lnternet。公网IP全Internet唯一统一分配（类似于护照号码)。  
​				**②私网**：私网IP各个局域网内使用，都是172,192,10...开头(类似于叫张三、李四，只在小网络内唯一，但出去就会重名)。

## 4.2. NAT概念

​		NAT= Network Address Translation = 网络地址转换  
​		**（1）作用：**就是专门解决私网IP到公网IP的转换的。NAT转发能力，是衡量路由器/网关的一个关键指标。

# 5.Routing

## 5.1.Routing概念

​		路由(Routing)是指IP数据包从源到目的地时，决定网络转发路径怎么选的过程。  
​		路由工作在OSI参考模型第三层——网络层的数据包转发设备。路由器(Router)会按照路由表(类似于网络世界的地图导航)的查找，转发数据包来实现网络互连。

## 5.2. 路由类型

​		静态路由：Static Routing

