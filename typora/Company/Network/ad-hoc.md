[TOC]



# 1.概念

## 1.1. 自组网功能

​		设备发现、主设备选举以及全局配置同步等功能。  
​		设备自组网后，登录组网内的任意一台设备，便可进行**整网管理**，包括:  
​			①可查看网络中所有设备信息及状态等。  
​			②可对设备进行网络配置。  
​			③可查看整网所有连接的终端信息。    
​			④可对所有设备进行升级操作、恢复出厂等。

## 1.2. 虚拟网络功能： 

​		虚拟网络 = networkId    
​				① 每一台设备只属于某一个虚拟网络。  
​				② 只有属于同一虚拟网络的设备才能组网在一起。       
​				③ 属于不同虚拟网络的设备需要进行合并操作后，才能组网在一起。  
​				④ 出厂设备属于同一个默认虚拟网络(networkld=O)。    
​				⑤用户首次对出厂设备进行配置操作后(开局)，将自动形成一个新虚拟网络(networkld为非0)。  
​						形式包括：APP/eweb/MACC

## 1.3. 二层组网原理

### 1.3.1. 报文类型

| 报文类型 | 功能                                                         |
| -------- | ------------------------------------------------------------ |
| declare  | 声明报文（(广播），在Init状态的时候，广播declare报文。       |
| reject   | 拒绝报文（单播），在收到declare报文时，并且根据选举优先级，自身优先级更高的情况下，回复reject。 |
| join     | 加入报文（广播)﹔由Master发送，其它的Init状态收到该报文时，根据其中的master信息连接该Master，类似beacon报文。 |
| conflict | 冲突报文（单播）;Master在收到其它的Master的join报文，并且根据冲突处理算法无法解决时，发送conflict报文。(兼容旧版本) |
| merge    | 兼并报文（单播）;Master在收到其它的Master的join报文，并且根据冲突处理算法可以兼并对方的网络时，发送merge报文。 |
| hello    | hello报文（单播)﹔设备在角色状态确定后，开始单播hello报文给主设备，用于保活 |

### 1.3.2. 状态机

![image-20230302160259002](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230302160259002.png)

### 1.3.3. 注意点

  		1. 设备的自发现基于二层广播，因此若希望所有设备都能进行自组网，需要**保证设备在同一个二层网络**，不能有vlan/端口隔离，否则会组成多个网络。    
  		2.  Router模式下，基于br-lan口进行组网,即用br-lan口
       的IP地址进行自发现和mqtt通信;  
        其他模式(AC模式/AP模式/中继模式)，则基于br-wan口进行组网，即用br-wan口的IP地址进行自发现和mqtt通信。  
  		3. NBS交换机比较特殊，它基于br-wan口进行组网，并
       且优先级是整网设备中最低的，不适用于设备优先级定义原则。(NBS之间也可以自组网)
  		4. ACG/AC角色的设备(EG/NBC)会将新设备
       (networkid=0)自动吸入到自身网络中。

## 1.4. 三层组网

​		三层组网需要跨段组网，而二层广播又无法跨越三层?  
​		通过dhcp option 43字段将三层上的master的IP地址告诉slave设备。

​		AP和NBS设备，在接收到dhcp option 43字段，并解析到master的IP地址信息后，将master信息通告给设备的相关进程(即自组网进程mqtt)。  
​		Option 43配置格式:`
#RJ#192.168.110.1，192.168.110.2
`  
**说明:**  
​		`#RJ#`
为字段头部，用于区分该option43是否是配给EAP使用的。  
​		`192.168.110.1`为主master的IP地址。    
​		`192.168.110.2为`备master的IP地址。  
PS:

​		(注:主备master,中间用英文逗号(,)隔开)

## 1.5. 自组网相关进程服务

发现服务(easydisc)
负责邻居发现、master选举，通告master变更。

组网服务(mqtt)
负责组网设备信息汇集、sta信息汇集、配置信息同步等。

## 1.6.自组网进程服务交互

### 1.6.1.单台设备

![image-20230302173630802](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230302173630802.png)

### 1.6.2.多台设备

![image-20230302173649812](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230302173649812.png)