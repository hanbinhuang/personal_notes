[TOC]



# 1.设备层

## 1.1. 产品结构（H30M）

![image-20230225154814018](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230225154814018.png)



## 1.2. 设备模块

**（1）CPU**:   MT7981B    
**（2）无线收发芯片**：MT77976DA  
**（3）交换芯片（switch）**：MT7531AE  
**（4）RFID芯片**：FM17580    
**（5）FLASH**（16M = 128 / 8bit）： SPI Nor flash/Winbond W25Q128JVSIQ    
**（6）内存**（256M）：DDR3    
**（7）网口**：RJ45，共有4个，其中WAN口（1个）直接接在CPU上，LAN口（3个）由交换芯片分配    
		**①WAN口**：广域网接口，主要是用于设备与广域网进行连接，一般连接光猫或其他网络设备;  
		**②LAN口**:局域网接口，主要是用于链接局域网中的设备，包括电脑、交换机、打印机等设备;



# 2. 概念

## 2.1. 多WAN

### 2.1.1. 场景需求

​		场景需求1：既要内部网络，又要访问互联网  
​		场景需求2：使用人数太多造成网络速率低，增加ISP接入提高上网速率 。  

### 2.2.2. 概念：





## 2.2. VLAN

### 2.2.1. 概念

​		VLAN = Virtual Local Area Network = 虚拟局域网。

​		**作用：**一种将局域网设备从逻辑上划分成一个个网段，从而实现虚拟工作组的数据交换技术，即：  
​				将一个物理LAN在逻辑行划分为多个广播域，VLAN内可直接通信，VLAN间不可之间通信（广播报文限制字一个VLAN中）  
​				一个VLAN = 一个逻辑子网 = 一个逻辑广播域。    
​		**协议：**802.1Q。

**PS:**    
		**冲突域**：可能发生冲突的范围。    
			说明：每次冲突所有传输都需停止一段时间,导致网络传输效率降低。  
			第一层设备（hub）不隔离冲突域，更不隔离广播域。  
		**广播域**：能够广泛传播的范围。  
			第二层设备（交换机）能隔离冲突域，但不隔离广播域。    
			第三层设备（路由器）隔离冲突域与广播域，可分隔和定义广播域。

### 2.2.2. 优点

​		**1.控制广播风暴**：一个VLAN的广播风暴不会影响到其他VLAN。  
​		**2.安全**：不同VLAN属于不同广播域，不同广播域之间不可通讯。  
​		**3.简化管理**：同一物理网络下课通过VLAN轻松划分逻辑网络。

### 2.2.3.划分方法

​		**1.基于端口划分**：指定对应端口为某VLAN。  
​			优缺点：简单，但用户移动到新端口需重新划分。  
​		**2.基于MAC地址划分**：指定MAC地址为某VLAN。  
​			优缺点：移动到新端口无需重新划分，但数量多则复杂，执行效率低，更换网卡则需重新配置。  
​		**3.基于子网划分**：根据每个主机的网络层地址或协议类型(如果支持多协议)划分。  
​			优缺点：移动位置无需重新划分,但更简单的改变网络结构。  
​		**4.基于用户划分**：基于用户定义、非用户授权来划分VLAN  
​			优缺点：适应特别的VLAN网络，但需用户与密码。

### 2.2.4.帧结构

![img](file:///C:\Users\acer\AppData\Local\Temp\ksohtml15368\wps1.jpg)

**1.TPID** (Tag Protocol Identifier，也就是EtherType)    
		IEEE定义的新的类型，表明这是一个加了802.1Q标签的帧。TPID包含了一个固定的值0x8100。

**2.TCI** (Tag Control Information)  
		**<1>User Priority**：用于定义用户优先级，共8个优先级别。IEEE 802.1P 为3比特的用户优先级位定义了操作。  
			①最高优先级为7：应用于关键性网络流量，如路由选择信息协议（RIP）和开放最短路径优先（OSPF）协议的路由表更新。    
			②优先级6和5：主要用于延迟敏感（delay-sensitive）应用程序，如交互式视频和语音。  
			③优先级4到1：主要用于受控负载（controlled-load）应用程序，如流式多媒体（streaming multimedia）和关键性业务流量（business-critical traffic）。  
			④优先级0是缺省值，并在没有设置其它优先级值的情况下自动启用。  
		**<2>CFI**(规范格式指示器Canonical Format Indicator)：用在令牌环/源路由FDDI介质访问方法中来指示封装帧中所带地址的比特次序信息。   
			①CFI值为0为规范格式。  
			②CFI值为1为非规范格式。  
		**<3> VID**：12-bit，用于VLAN 的识别字段，在标准 802.1Q 中常被使用，支持VLAN 的识别。  
			范围：0~4095，其中0和4095为协议保留值。  
			① 0：不属于任何VLAN，但携带802.1Q的优先级标签，一般被称为Priority-only frame，其一般作为系统使用，用户不可使用和删除。  
			② 1：系统默认VLAN = PVID，即Native VLAN（Primary vlan）。  
			③ 2-1001：普通的vlan。  
			④ 1002-1005：支持fddi和令牌环的vlan。  
			⑤ 1006-1024：保留仅系统使用，用户不能查看和使用。  
			⑥ 1025-4095：是扩展的vlan。

### 2.2.5.三要素

​		**1.PVID = 端口缺省VID**：用以确定untagged帧所属的VLAN。   
​		**2.VLAN成员表**：用以指定端口是否在VLAN中。（swconfig 最后的vlan对应的port）  
​		**3.VLAN输出tag表**：用以确定报文在输出时是否带有tag。

## 2.3. 接口类型、以太网帧格式、PVID

### 2.3.1. 接口类型

​		**（1）Access端口：**该端口一般用于连接不能识别Tag的终端设备。（只可传送一个VLAN包）  
​		  **<1>三元素**：  
​				①VLAN成员表：用户指定，但是只能在一个VLAN中。  
​				②PVID：无需指定，PVID和端口所在VLAN一样。  
​				③VLAN输出tag表：**输出始终为untagged**。   
​	      **<2>设备举例**：计算机，服务器，机顶盒等设备   
​		**（2）Trunk端口：**该端口一般用于可同时收发Tag与Untag的终端设备之间的连接。（可传送多个VLAN包）  
​		  **<1>三元素**：  
​				①VLAN成员表：用户指定，Trunk口可在多个VLAN中。缺省情况在设备所创建的所有VLAN中。  
​				②PVID：需要用户指定，指定方式为配置端口的Native VLAN。若未指定，缺省为1。  
​				③VLAN输出tag表：**若输出报文是在端口的Native vlan中，即untagged输出，否则均为tag输出**。  
​		  **<2>设备举例**：交换机，路由器，AP等设备。

### 2.3.2.以太网帧格式

​		**① tag帧**:指以太网数据帧中**携带4字节802.1Q信息的VLAN标签**，其中vlan id用于指名数据包属于哪个vlan。  
​		**② untag帧**:指以太网数据帧中**不携带数据包802.1Q信息的VLAN标签**，不属于任何vlan。

### 2.3.3. PVID概念

​		PVID = port VLAN ID = 端口缺省VLAN ID  ，缺省vlan = native vlan = pvid vlan  
​		**1.作用：**用于端口确定untagged帧所属的VLAN  
​				①.**标记标签**作用，即：接收untag包添加本端口的PVID再进行转发。  
​				②.**接收过滤**作用，如：只接收等于PVID的VLAN TAG包。  
​		**2.PVID与端口关系：**  
​				①**trunk端口**属于多VLAN，故需设置缺省VLAN ID，默认为1.  
​				若设置缺省VLAN ID时，  
​						<1>当端口接收untag 报文则会将其转发到缺省VLAN ID.    
​						<2>当端口接收缺省VLAN ID相同报文时，则去掉VLAN ID为untag报文再转发。   
​				②**access端口**仅属于一个VLAN，所在VLAN即为缺省VLAN ID。  

### 2.3.4. VLAN报文输入输出规则

<table align=“center”>
    <tr>
     <th rowspan="2">端口类型
     <th colspan="2">对接收报文的处理
     <th rowspan="2">对发送报文的处理
    </tr>
     <tr>
     <td>报文为untag
     <td>报文为tag
    </tr>
    <tr>
     <td>Access口
     <td>接收并为报文打上PVID的tag
     <td>若tag的VLAN ID = PVID:<br>    接收报文<br>若tag的VLAN ID != PVID:<br>    丢弃报文
     <td>(前面可知报文均为tag 为PVID，故去掉tag)untag报文发送    
    </tr>
     <tr>
     <td>Trunk口
     <td>若PVID = 端口允许的VLAN列表中：接收并为报文打上PVID的tag<br>若PVID != 端口允许的VLAN列表中：  丢弃报文
     <td>若tag的VLAN ID = 端口允许的VLAN列表中：接收报文<br>若tag的VLAN ID != 端口允许的VLAN列表中：   丢弃报文
     <td> (前面可知报文有：①tag VID为PVID，②tag VID为端口允许VLAN列表中)<br>①发送的报文为untag<br>②发送的报文为原有tag 
    </tr>
</table>    


### 2.3.5. VLAN中的ports字段

​		每个VLAN的配置中都有个ports字段，ports字段中对应的数字即为SWITCH对应的端口序号，其中数字后有些会携带字母“t”，有些则不带“t”字符：  
​		1、 数字后代“t”的，表示该接口转发本VLAN时需要携带VLAN（即转发该VLAN时不剥离VLAN TAG）；  
​		2、 如果数字后面不带“t”，那么SWITCH端口接收到UNTAG的报文就会认为该报文属于本VLAN并对该报文打上TAG，然后在switch内部进行转发；发送本VLAN的报文时，该端口会将报文中的TAG剥掉，然后转发出去。  
​		vlan0是默认的vlan（若数据包为untag，则将被视为vlan0数据包）  
​		一個 port 只可以有一個 PVID, 但它們可以同時屬於多個 VID  
​		pvid：端口上未标记的入站数据包被分配了VID  
​		若入端口的数据报为untag，则会被加上PVID tag

### 2.3.6. VLAN通信

![image-20230302213324131](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230302213324131.png)

![image-20230302213331662](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230302213331662.png)



## 2.4. 二三层转发

### 2.4.1. 二层转发

**(1) 概念**：  
		OSI七层模型中**第二层链路层**，根据报文的**目的mac地址**对报文进行转发，故称为二层转发。  
		二层转发中**不对报文的头部做任何修改**。  
**(2) 二层设备：网桥.**  
		**①特点**：可连接不同速率的链路，不限制连接网段，错误检测，流量控制，较集线器相比，可起到过滤的作用。  
		**②作用**：连接两个网络的设备（根据MAC地址处理），分析目的MAC地址字段是否在对方网络上，并据此决定是否将报文转发到对方网络。  
 **(3) 桥接：**  
		即将两台在同一网段的设备通过网桥连接在一起，网桥下的设备可根据MAC地址把设备上的报文原封不动的送给另一台设备，故可说网桥设备在整个链路上是透明的。  
**(4) FDB表（转发信息表）：**  
		每个网桥内部维护一张FDB表，包含信息如下：  
				1.mac：设备的MAC地址。  
				2.port: 对应设备连接的端口。  
		FDB表的更新：每接收报文都会根据报文源MAC地址及报文接收端口更新。  
		FDB表的老化：定时清理长时间不用/无效的表项。  
**(5)相关命令**：  
		**刷新mac表**：`swconfig dev switch0 set flush_arl`	  
		**输出mac表：**`mactable/`

### 2.4.2.三层转发

**(1)概念：**  
		OSI七层模型中**第三层网络**层，根据报文的**IP地址**对报文进行转发，故称为三层转发。  
		三层转发中对报文的二层头部进行相应修改（检查IP报文头、修改存活时间（TTL）参数、重新计算IP头校验和、IP包的数据链路封装等等）。  
**(2)三层设备：路由.**  
		**①特点**：记录网络地址与下一跳路由器地址、分担网络负荷、网络安全等功能，通过网络层转发分组数据的设备  
		**②作用**：连接两个网络的设备（根据IP地址处理）  
		**③路由选路：**  
				<1>**最长地址匹配（逐包转发）**  
						a.若网段相同则认为该匹配项与路由匹配。  
						b. 所有匹配项中，子网掩码位数最长为最佳匹配。  
						c. 若找不到匹配项则根据缺省路由0.0.0.0/0进行转发    
						d. 若无缺省路由则丢弃该报文  
			     **优缺点**：即使在加载大量路由、网络路由频繁波动、网络蠕虫极其严重的情况下，仍然保证IP报文的线速转发，因而可以保障正常业务的运行。    
				<2>**精确匹配（流转发）**  
						a. 根据目的IP在L3FDB表中查找。  
						b. 找不到则使用最长地址匹配查找并将其加入L3FDB表中  
						c. 表项长期不被刷新则老化。  
				**优缺点**：无法适应网络的动荡，更严重的是在“冲击波”等网络蠕虫病毒发作时可能会使全网陷于瘫痪  
				<3>**不同网络主机之间的互访过程？**  
						源主机发起通讯前会将自己的IP地址与目的主机的IP地址进行比较，  
						1.（**二层转发通讯**）若为同一网段/同一VLAN，则直接向目的主机发起ARP请求。收到ARP请求应答后得到目的主机MAC地址，则直接用该MAC地址进行报文发送。  
						2.（**三层转发通讯**）若为不同网段/不同VLAN，则会通过网关来递交报文（发送ARP请求获取网关的MAC地址），收到ARP应答后得到网关MAC地址，用网关MAC进行报文发送。【注意：发送报文的源IP仍是源主机IP，目的IP仍是目的主机IP】  

**PS:**   
		网段 = IP地址+子网掩码计算后的网络号

### 2.4.3. 转发模式

​	**（1）桥转发**：**同网段下**，终端报文经过设备后，直接根据设备内维护的**转发表**，把报文直接原封不动的转发出去。

​	**（2）路由转发**：**不同网段下**，终端仍可以直接相互访问，是通过设备的**路由表**进行转发的。

​	**（3）NAT转发**：路由器将从终端收到的报文和转发给终端的报文进行地址替换的转发方式。

### 2.4.4. 实际场景

​	**（1）直连**

![image-20230303085925067](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230303085925067.png)

​	**（2）桥转发**

![image-20230303085942017](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230303085942017.png)

​	**（3）路由转发**

![image-20230303090139337](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230303090139337.png)

​	**（4）NAT转发**

![image-20230303090301138](C:\Users\acer\AppData\Roaming\Typora\typora-user-images\image-20230303090301138.png)



## 3.组件说明

## 3.1. swconfig组件

​		**①作用**：为应用层提供命令，配置交换机芯片的底层驱动。  
​		**②文件工程目录**：`packages18_06/network/config/swconfig/`

## 3.2. netifd组件

### 3.2.1. 概念

​		netifd = net interface damon，一个具有RPC特性的守护进程。  
​		**<1>作用**：OpenWrt中用于进行网络配置的守护进程，基本上所有网络接口设置以及内核的netlink事件都可以由netifd来处理完成。  		**<2>文件工程目录**：`packages18_06/network/services/netifd`  
​		**<3>组成：**  
​				①/lib/network/*.sh  
​				②/sbin/ifup  
​				③一些/etc/hotplug.d脚本

### 3.2.2.工作原理

​		在netifd**启动前**用户需将所需的配置写入uci配置文件`/etc/config/network`中，以告知netifd如何设置这些网络接口，如：  
​				IP地址、上网类型等。  
​		在netifd**运行过程中**需要修改配置，则只需更新并保存`/etc/config/network`，执行`/etc/init.d/network reload`，netifd便可根据配置文件差异快速地完成网络接口的更新。

### 3.2.3.整体框架

![img](file:///C:\Users\acer\AppData\Local\Temp\ksohtml15368\wps2.jpg)

**1.proto层（协议层**）:配置设备的**接入方式**(协议)，如：  
		static(静态IP)、DHCP(动态IP)、PPPOE、none等。（设置完需更新L3属性）

**2.interface层（接口层）**：配置设备的**L3层属性**，如：  
		IP地址，路由（包括应用层的DNS）等。

**3.device层（设备层）**：配置设备的**L2层属性**，如：  
		mac地址、mtu（最大传输速率）、协商速率等。

## 3.3. dnsmasq组件

​		**①作用**：用于小型网络，提供DNS功能和DHCP功能。  
​				判断LAN网络是否需要提供DHCP server功能，如果需要则添加DHCP相关规则配置  
​		**②文件工程目录**：

## 3.4. firewall组件

​		**①作用**：OpenWrt下的**网络转发**及**网络安全**相关规则都是由Firewall组件进行控制管理的。  
​		**②文件工程目录**：



# 3. 网络框架

## 3.1. 网络框架的目的：

​			**设备层**：网卡，**适配层**：网络配置框架，**应用层**：网络应用。   
​			**作用：**  
​					①由于设备层形态各异，配置方法各不相同，故需要一个适配层用于向应用层提供统一的接口。    
​					②将系统模块提供网络配置组合，为用户提供直观的网络配置。

## 3.2. 



# 4.常用命令

